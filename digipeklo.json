<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>√önikov√° hra - HESLO</title>
<style>
  body {
    box-sizing: border-box;
  }
  
  :root{
    --bg:#00a8cf; --white:#fff; --muted:rgba(255,255,255,.8); --muted2:rgba(255,255,255,.6);
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--white);overflow:hidden}
  .screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;transition:opacity 0.8s ease-in-out, transform 0.8s ease-in-out;opacity:1;transform:translateY(0)}
  .hidden{opacity:0;transform:translateY(-20px);pointer-events:none}
  .screen.slide-out{opacity:0;transform:translateY(-50px)}
  .screen.slide-in{opacity:1;transform:translateY(0)}
  
  /* LOCK */
  .lock-wrap{position:relative;width:100%;height:100%;cursor:pointer}
  .lock-logo{position:absolute;left:50%;top:33%;transform:translateX(-50%);display:flex;align-items:center;gap:18px}
  .lock-logo .txt{font-weight:800;font-size:48px}
  .lock-logo .arrow{background:var(--white);color:#20899b;font-weight:900;border-radius:6px 0 6px 6px;padding:12px 22px 10px;clip-path:polygon(0 0, 86% 0, 100% 50%, 86% 100%, 0 100%);} 
  .lock-help{position:absolute;right:24px;bottom:24px;text-align:right;font-size:14px;line-height:1.25;color:var(--muted2)}
  .lock-time{position:absolute;left:24px;bottom:24px;font-size:64px;font-weight:700;letter-spacing:1px}
  .lock-date{position:absolute;left:26px;bottom:84px;font-size:22px;color:var(--muted)}
  .hint-any{position:absolute;left:50%;bottom:44px;transform:translateX(-50%);font-size:14px;color:var(--muted2)}

  /* LOGIN */
  .login-card{background:none;border:none;box-shadow:none;padding:0;text-align:center;width:auto}
  .avatar{width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,.2);display:inline-grid;place-items:center;margin:0 auto 20px;font-size:48px}
  .username{font-weight:600;font-size:26px;margin:0 0 10px}
  .input-row{display:flex;flex-direction:column;gap:12px;align-items:center;margin:20px 0}
  /* stejn√° metrika pro v≈°echny prvky */
  *, *::before, *::after { box-sizing: border-box; }

  /* sjednocen√≠ v√Ω≈°ky input+≈°ipky */
  .login-input {
    --row-h: 40px;          /* m≈Ø≈æe≈° klidnƒõ zmƒõnit na 42‚Äì44px podle chuti */
    height: var(--row-h);
    display: flex;
    align-items: stretch;   /* a≈• se dƒõti nat√°hnou na celou v√Ω≈°ku */
    width:340px;max-width:85vw;
    border-radius: 4px;
    overflow: hidden;
    gap: 0;
  }

  .login-input input {
    flex: 1;
    min-width: 0;           /* CRUCIAL fix pro flexbox overflow */
    height: 100%;           /* stejn√° v√Ω≈°ka jako kontejner */
    padding: 0 12px;        /* vertik√°ln√≠ padding pryƒç, a≈• sed√≠ v√Ω≈°ka */
    border: none;
    font-size: 16px;
    outline: none;
  }
  
  .login-input.user input{background:#fff;color:#000}
  .login-input.pass input{background:#003840;color:#fff}

  .login-input.pass .password-controls {
    display: flex;
    align-items: stretch;
    height: 100%;
    gap: 0;
  }
  
  .login-input.pass .eye-btn {
    all: unset;
    display: none;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 0 8px;
    min-width: 36px;
    background: none;
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    line-height: 1;
    font-size: 14px;
  }
  
  .login-input.pass .eye-btn.visible {
    display: grid;
    place-items: center;
  }
  
  .login-input.pass .eye-btn:hover {
    color: rgba(255,255,255,0.9);
  }
  
  .login-input.pass .submit-btn {
    all: unset;
    display: grid;
    place-items: center;
    height: 100%;
    padding: 0 14px;
    min-width: 44px;
    background: rgba(255,255,255,0.18);
    color: #fff;
    cursor: pointer;
    line-height: 1;
    font-size: 18px;
  }
  
  .login-input.pass .submit-btn:hover {
    background: rgba(255,255,255,0.28);
  }
  input::placeholder{color:#666}
  .input-group{margin:6px 0}
  .input-group input{width:300px;max-width:80vw;padding:8px 10px;border-radius:4px;border:1px solid #ccc;background:#fff;color:#000;font-size:16px;outline:none}
  .other-user-form{margin-top:20px}
  .domain-info{margin-top:20px;font-size:14px;color:var(--muted)}
  .domain-info p{margin:5px 0}
  .domain-info a{color:var(--white);text-decoration:underline}
  .domain-info a:hover{color:#2bc4d0}
  button{background:none;border:none;font-size:28px;margin-top:10px;cursor:pointer;color:white;padding:5px}
  button:hover{color:#2bc4d0}
  .account-tiles{position:absolute;left:18px;bottom:24px;display:flex;flex-direction:column;gap:10px}
  .acct{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.18);padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);font-size:14px;cursor:pointer}
  .acct:hover{background:rgba(0,0,0,.25)}
  .acct .dot{width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.5);display:grid;place-items:center;font-size:12px;font-weight:bold}
  .corner-icons{position:absolute;right:18px;bottom:18px;display:flex;gap:10px;opacity:.85}
  .corner-icons .icon{width:34px;height:34px;border-radius:8px;background:rgba(255,255,255,.18);display:grid;place-items:center;border:1px solid rgba(255,255,255,.2);cursor:pointer;font-size:16px}
  .corner-icons .icon:hover{background:rgba(255,255,255,.25)}

  /* DESKTOP */
  .desktop{position:absolute;inset:0;background:linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);display:flex;flex-direction:column}
  .desktop.custom-bg{background-image:var(--custom-wallpaper);background-size:cover;background-position:center}
  
  /* Taskbar */
  .taskbar{position:absolute;bottom:0;left:0;right:0;height:48px;background:rgba(0,0,0,0.8);backdrop-filter:blur(10px);display:flex;align-items:center;padding:0 8px;border-top:1px solid rgba(255,255,255,0.1)}
  .start-btn{display:flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:white;font-weight:600;transition:background 0.2s}
  .start-btn:hover{background:rgba(255,255,255,0.2)}
  .start-icon{font-size:18px}
  .start-text{font-size:14px}
  .taskbar-apps{display:flex;gap:4px;margin-left:16px}
  .app-btn{width:40px;height:40px;display:grid;place-items:center;background:rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;font-size:18px;transition:background 0.2s}
  .app-btn:hover{background:rgba(255,255,255,0.2)}
  .system-tray{margin-left:auto;display:flex;align-items:center;gap:8px;color:white}
  .tray-icon{padding:4px;cursor:pointer;opacity:0.8;transition:opacity 0.2s}
  .tray-icon:hover{opacity:1}
  .tray-time{font-weight:600;font-size:14px;padding:4px 8px}
  
  /* Desktop Icons */
  .desktop-icons{position:absolute;top:20px;left:20px;display:grid;gap:20px;grid-template-columns:repeat(auto-fit, 80px)}
  .desktop-icon{display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer;transition:background 0.2s;color:white;text-align:center}
  .desktop-icon:hover{background:rgba(255,255,255,0.1)}
  .icon-image{font-size:32px;margin-bottom:4px}
  .icon-label{font-size:12px;line-height:1.2;word-wrap:break-word;max-width:80px}
  
  /* Start Menu */
  .start-menu{position:absolute;bottom:56px;left:8px;width:320px;background:rgba(0,0,0,0.9);backdrop-filter:blur(20px);border-radius:12px;border:1px solid rgba(255,255,255,0.1);color:white;box-shadow:0 20px 40px rgba(0,0,0,0.5)}
  .start-menu.hidden{display:none}
  .start-header{padding:16px;border-bottom:1px solid rgba(255,255,255,0.1)}
  .user-info{display:flex;align-items:center;gap:12px}
  .user-avatar{width:40px;height:40px;background:rgba(255,255,255,0.2);border-radius:50%;display:grid;place-items:center;font-size:20px}
  .user-name{font-weight:600;font-size:16px}
  .start-apps{padding:8px 0}
  .start-app{display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;transition:background 0.2s}
  .start-app:hover{background:rgba(255,255,255,0.1)}
  .app-icon{font-size:20px;width:24px;text-align:center}
  .app-name{font-size:14px}
  .start-footer{padding:8px;border-top:1px solid rgba(255,255,255,0.1)}
  .power-btn{display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;transition:background 0.2s;border-radius:6px}
  .power-btn:hover{background:rgba(255,255,255,0.1)}
  .power-icon{font-size:18px}
  .power-text{font-size:14px}
  
  .error-msg{color:#ffcccc;font-size:14px;margin-top:10px;min-height:20px;text-shadow:1px 1px 2px rgba(0,0,0,0.5)}
  
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  
  /* NOTES MODAL */
  .notes-modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity 0.3s ease}
  .notes-content{background:#fff;color:#333;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 40px rgba(0,0,0,0.3)}
  .notes-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px 0;border-bottom:1px solid #eee;margin-bottom:20px}
  .notes-header h3{margin:0;font-size:20px;color:#333}
  .close-btn{all:unset;cursor:pointer;font-size:24px;color:#666;padding:4px;line-height:1}
  .close-btn:hover{color:#333}
  .notes-body{padding:0 24px 24px;line-height:1.6}
  .notes-body p{margin:0 0 16px}
  .notes-body code{background:#f5f5f5;padding:2px 6px;border-radius:4px;font-family:monospace;color:#d63384}
  
  /* SYSTEM MODAL */
  .sys-modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:1100}
  .sys-modal.hidden{display:none}
  .sys-card{background:#fff;color:#222;border-radius:12px;box-shadow:0 20px 40px rgba(0,0,0,.35);width:min(520px,92vw);max-height:80vh;overflow:auto}
  .sys-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid #eee}
  .sys-head h3{margin:0;font-size:18px}
  .sys-close{all:unset;cursor:pointer;font-size:22px;line-height:1;color:#666;padding:4px 8px}
  .sys-close:hover{color:#111}
  .sys-body{padding:16px 18px;line-height:1.55}
  .sys-body p{margin:0 0 10px}
  .sys-body code{background:#f6f6f6;padding:2px 6px;border-radius:4px}
  
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center;
    padding:16px; background:rgba(0,0,0,.35); z-index:2000;
  }
  .overlay.hidden{ display:none }

  .glass-card{
    backdrop-filter:saturate(120%) blur(14px);
    background:rgba(0,0,0,.16);
    border:1px solid rgba(255,255,255,.12);
    width:min(680px,92vw); border-radius:18px; padding:24px 22px; color:#fff;
    max-height:80vh; overflow:auto;
  }
  .glass-card h2{margin:0 0 10px;font-size:22px;font-weight:700}
  .glass-card p{margin:0 0 12px;color:rgba(255,255,255,.9)}
  .glass-card input{
    width:100%;
    border:1px solid rgba(255,255,255,.35);
    background:rgba(3,3,3,.16);
    color:#fff;
    border-radius:8px;
    padding:10px 12px;
    font-size:16px;
    outline:none;
    margin:6px 0;
    box-sizing:border-box;
  }
  .btn-primary, .btn-secondary{
    all:unset; cursor:pointer; border-radius:10px; padding:10px 14px; font-weight:800;
  }
  .btn-primary{ background:#2bc4d0; color:#003e44 }
  .btn-secondary{ background:rgba(255,255,255,.14); color:#fff }
  .btn-primary:hover{ filter:brightness(.95) }
  .btn-secondary:hover{ background:rgba(255,255,255,.22) }
  .btn-primary:disabled{
    background:rgba(255,255,255,.2);
    color:rgba(255,255,255,.5);
    cursor:not-allowed;
  }
  .meter{height:8px;background:rgba(255,255,255,.18);border-radius:999px;overflow:hidden;margin:6px 0}
  .meter i{display:block;height:100%;width:0;background:#2bc4d0;transition:width .2s ease}
  .rule-list{list-style:none;margin:10px 0 0;padding:0}
  .rule-list li{font-size:14px;color:rgba(255,255,255,.75);margin:4px 0;position:relative;padding-left:22px}
  .rule-list li::before{content:"‚úó";position:absolute;left:0;color:#eee;background:rgba(255,255,255,.12);width:20px;height:20px;display:grid;place-items:center;border-radius:6px}
  .rule-list li.ok{color:#c9ffd9}
  .rule-list li.ok::before{content:"‚úì";color:#2ecc71;background:rgba(46,204,113,.25)}

  body.modal-open{ overflow:hidden }
  .timer{position:fixed;right:12px;top:12px;background:rgba(0,0,0,.5);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;z-index:3000}
  
  /* locked start items */
  .redfx{pointer-events:none;position:fixed;inset:0;mix-blend-mode:screen;background:radial-gradient(1200px 800px at 60% 20%,rgba(255,0,0,.22),transparent 60%),radial-gradient(700px 500px at 30% 80%,rgba(255,60,60,.18),transparent 60%);animation:redblink 5s infinite;z-index:3000}
  @keyframes redblink{0%,100%{opacity:.12;filter:brightness(1)} 45%{opacity:.35;filter:brightness(1.15)} 50%{opacity:.65;filter:brightness(1.35)} 55%{opacity:.35;filter:brightness(1.15)}}
  .start-app.locked{opacity:.32;filter:grayscale(.6)}
  .start-app.done{background:rgba(40,200,100,.18)}
  .wallpaper-note{position:fixed;left:0;right:0;top:0;padding:12px;text-align:center;font-weight:700;z-index:2500;transition:all .3s;color:#fff}
  .wallpaper-note.warn{background:rgba(200,30,30,.95)}
  .start-app.locked{ opacity:.32; filter:grayscale(.6); cursor:not-allowed; }

  /* v√Ωraznƒõj≈°√≠ red-studio overlay */
  .redfx{
    pointer-events:none;
    position:fixed; inset:0;
    mix-blend-mode:screen;
    background:
      radial-gradient(1200px 800px at 60% 20%, rgba(255,0,0,.28), transparent 60%),
      radial-gradient(700px 500px at 30% 80%, rgba(255,60,60,.22), transparent 60%),
      radial-gradient(500px 300px at 85% 65%, rgba(255,90,90,.18), transparent 60%);
    animation:redblink 5s infinite, redsweep 12s linear infinite;
    z-index:3000;
  }
  @keyframes redblink{
    0%,100%{opacity:.12;filter:brightness(1)}
    45%{opacity:.35;filter:brightness(1.15)}
    50%{opacity:.70;filter:brightness(1.35)}
    55%{opacity:.35;filter:brightness(1.15)}
  }
  @keyframes redsweep{
    0%{background-position: 60% 20%, 30% 80%, 85% 65%}
    50%{background-position: 65% 25%, 25% 75%, 80% 60%}
    100%{background-position: 60% 20%, 30% 80%, 85% 65%}
  }

  .start-app{position:relative; overflow:hidden; transition:transform .15s, background .25s, box-shadow .25s;}
  .start-app.done{
    background:linear-gradient(180deg, rgba(46,204,113,.22), rgba(46,204,113,.08));
    box-shadow:0 0 0 1px rgba(46,204,113,.45), 0 10px 18px rgba(46,204,113,.18);
  }
  .start-app.done::after{
    content:"‚úì";
    position:absolute; right:12px; top:10px;
    font-weight:900; font-size:14px;
    background:rgba(46,204,113,.85); color:#073;
    border-radius:8px; padding:2px 6px; border:1px solid rgba(255,255,255,.5);
  }
  .start-app.done.pulse{ animation:donePulse 900ms ease-out 1; }
  @keyframes donePulse{
    0%{ box-shadow:0 0 0 0 rgba(46,204,113,.65); transform:scale(1.00); }
    70%{ box-shadow:0 0 0 14px rgba(46,204,113,0); transform:scale(1.02); }
    100%{ box-shadow:0 0 0 0 rgba(46,204,113,0); transform:scale(1.00); }
  }

  /* Final lock styles */
  .final-lock{
    background:linear-gradient(135deg, rgba(43,196,208,.2), rgba(43,196,208,.05));
    border:2px solid rgba(43,196,208,.6);
    box-shadow:0 0 20px rgba(43,196,208,.3);
  }
  @keyframes lockPulse{
    0%{ box-shadow:0 0 20px rgba(43,196,208,.3); transform:scale(1); }
    50%{ box-shadow:0 0 30px rgba(43,196,208,.6); transform:scale(1.05); }
    100%{ box-shadow:0 0 20px rgba(43,196,208,.3); transform:scale(1); }
  }

  /* Final lock overlay */
  .final-lock-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.85);display:grid;place-items:center;
    z-index:5000;backdrop-filter:blur(8px);
  }
  .final-lock-card{
    background:linear-gradient(135deg, #0a0a0a, #1a1a2e);
    border:2px solid #2bc4d0;
    border-radius:20px;
    padding:30px;
    box-shadow:0 0 50px rgba(43,196,208,.4), inset 0 0 30px rgba(43,196,208,.1);
    color:#fff;
    max-width:600px;
    width:90%;
  }
  .final-lock-title{
    text-align:center;
    font-size:28px;
    font-weight:800;
    margin:0 0 20px;
    color:#2bc4d0;
    text-shadow:0 0 10px rgba(43,196,208,.5);
  }
  .lock-segments{
    display:grid;
    grid-template-columns:repeat(6,1fr);
    gap:10px;
    margin:20px 0;
  }
  .lock-segment{
    position:relative;
    background:rgba(43,196,208,.1);
    border:2px solid rgba(43,196,208,.3);
    border-radius:10px;
    padding:15px 8px;
    text-align:center;
    transition:all 0.3s ease;
  }
  .lock-segment:focus-within{
    border-color:#2bc4d0;
    box-shadow:0 0 15px rgba(43,196,208,.5);
    background:rgba(43,196,208,.2);
  }
  .lock-segment input{
    all:unset;
    width:100%;
    text-align:center;
    font-size:18px;
    font-weight:700;
    color:#2bc4d0;
    text-transform:uppercase;
  }
  .lock-segment input::placeholder{
    color:rgba(43,196,208,.5);
    font-weight:400;
  }
  .lock-segment.error{
    border-color:#ff4757;
    background:rgba(255,71,87,.1);
    animation:shake 0.5s ease-in-out;
  }
  .lock-segment.success{
    border-color:#2ecc71;
    background:rgba(46,204,113,.1);
  }
  .lock-segment-label{
    position:absolute;
    top:-8px;
    left:50%;
    transform:translateX(-50%);
    background:#0a0a0a;
    padding:2px 8px;
    font-size:10px;
    color:rgba(43,196,208,.8);
    border-radius:4px;
  }
  .lock-controls{
    display:flex;
    gap:15px;
    justify-content:center;
    margin-top:25px;
  }
  .lock-btn{
    all:unset;
    cursor:pointer;
    padding:12px 25px;
    border-radius:10px;
    font-weight:700;
    transition:all 0.3s ease;
    text-align:center;
    min-width:100px;
  }
  .lock-btn.primary{
    background:linear-gradient(135deg, #2bc4d0, #1e90ff);
    color:#003e44;
    box-shadow:0 4px 15px rgba(43,196,208,.3);
  }
  .lock-btn.primary:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(43,196,208,.4);
  }
  .lock-btn.secondary{
    background:rgba(255,255,255,.1);
    color:#fff;
    border:1px solid rgba(255,255,255,.2);
  }
  .lock-btn.secondary:hover{
    background:rgba(255,255,255,.2);
  }
  .lock-message{
    text-align:center;
    margin-top:15px;
    font-size:14px;
    min-height:20px;
  }
  .lock-message.error{
    color:#ff4757;
  }
  .lock-message.success{
    color:#2ecc71;
  }
  .lock-hints{
    background:rgba(43,196,208,.05);
    border:1px solid rgba(43,196,208,.2);
    border-radius:10px;
    padding:15px;
    margin:15px 0;
    font-size:13px;
    line-height:1.4;
  }
  .lock-hints h4{
    margin:0 0 10px;
    color:#2bc4d0;
    font-size:14px;
  }
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    25%{transform:translateX(-5px)}
    75%{transform:translateX(5px)}
  }
</style>
</head>
<body>
  <!-- SCREEN 1: LOCK -->
  <div class="screen" id="lockScreen">
    <div class="lock-wrap" tabindex="0" onclick="goLogin()" onkeydown="if(event.key==='Enter') goLogin()">
      <div class="lock-logo">
        <div class="txt">Digit√°ln√≠</div>
        <div class="arrow">Peklo</div>
      </div>
      <div class="lock-date" id="lockDate">√∫ter√Ω 30. z√°≈ô√≠</div>
      <div class="lock-time" id="lockTime">9:22</div>
      <div class="hint-any">Klikni, nebo stiskni Enter pro p≈ôihl√°≈°en√≠</div>
      <div class="lock-help">
        Spr√°va informaƒçn√≠ch<br /> technologi√≠ mƒõsta Peklo<br /><br />
        Helpline: 666 666 666<br />
        http://canvaveskole.cz<br />
        www.peklo-edu.cz
      </div>
    </div>
  </div>

  <!-- SCREEN 2: LOGIN -->
  <div class="screen hidden" id="loginScreen">
    <div class="login-card">
      <div class="avatar">üë§</div>
      <div class="username">Jan Nov√°k</div>
      <div class="login-input pass" id="normalLogin">
        <input type="password" id="password" placeholder="Heslo" autocomplete="current-password">
        <div class="password-controls">
          <button type="button" class="eye-btn" id="eyeBtn" aria-label="Zobrazit heslo">üëÅ</button>
          <button type="button" class="submit-btn" id="btnGo" aria-label="P≈ôihl√°sit">‚Üí</button>
        </div>
      </div>
      <div class="error-msg" id="errorMsg"></div>
      
      <div class="other-user-form hidden" id="otherUserForm">
        <div class="input-row">
          <div class="login-input user">
            <input type="text" id="username" placeholder="U≈æivatelsk√© jm√©no" autocomplete="username">
          </div>
          <div class="login-input pass">
            <input type="password" id="otherPassword" placeholder="Heslo" autocomplete="current-password">
            <div class="password-controls">
              <button type="button" class="eye-btn" id="eyeBtnOther" aria-label="Zobrazit heslo">üëÅ</button>
              <button type="button" class="submit-btn" id="btnGoOther">‚Üí</button>
            </div>
          </div>
        </div>
        <div class="error-msg" id="errorMsgOther"></div>
        <div class="domain-info">
          <p>P≈ôihl√°sit se k dom√©nƒõ: <strong>PEKLO-EDU</strong></p>
          <p><a href="#" onclick="showDomainHelp()">Jak se p≈ôihl√°sit k jin√© dom√©nƒõ?</a></p>
        </div>
      </div>
    </div>
    
    <div class="account-tiles">
      <div class="acct" onclick="switchUser('admin')">
        <div class="dot">A</div>
        <span>Administrator</span>
      </div>
      <div class="acct" onclick="switchUser('other')">
        <div class="dot">?</div>
        <span>Jin√Ω u≈æivatel</span>
      </div>
    </div>
    
    <div class="corner-icons">
      <div class="icon" title="S√≠≈•" onclick="showNetworkInfo()">üì∂</div>
      <div class="icon" title="Nap√°jen√≠" onclick="showBatteryInfo()">üîã</div>
      <div class="icon" title="Pozn√°mky" onclick="showNotes()">üìù</div>
      <div class="icon" title="Nastaven√≠" onclick="showSettingsInfo()">‚öôÔ∏è</div>
    </div>
  </div>

  <!-- SCREEN 3: DESKTOP -->
  <div class="screen hidden" id="desktopScreen">
    <div class="desktop">
      <!-- Taskbar -->
      <div class="taskbar">
        <div class="start-btn" onclick="toggleStartMenu()">
          <span class="start-icon">ü™ü</span>
          <span class="start-text">Start</span>
        </div>
        <div class="taskbar-apps">
          <div class="app-btn" title="Pozn√°mkov√Ω blok" onclick="openNotepad()">üìù</div>
        </div>
        <div class="system-tray">
          <div class="tray-icon" title="S√≠≈•">üì∂</div>
          <div class="tray-icon" title="Zvuk">üîä</div>
          <div class="tray-icon" title="Baterie">üîã</div>
          <div class="tray-time" id="desktopTime">9:22</div>
        </div>
      </div>

      <!-- Desktop Icons -->
      <div class="desktop-icons">
        <div class="desktop-icon" ondblclick="openRecycleBin()">
          <div class="icon-image">üóëÔ∏è</div>
          <div class="icon-label">Ko≈°</div>
        </div>
        <div class="desktop-icon" ondblclick="openSecretFolder()">
          <div class="icon-image">üìÇ</div>
          <div class="icon-label">Tajn√©_soubory</div>
        </div>
      </div>

      <!-- Start Menu -->
      <div class="start-menu hidden" id="startMenu">
        <div class="start-header">
          <div class="user-info">
            <div class="user-avatar">üë§</div>
            <div class="user-name" id="desktopUserName">Jan Nov√°k</div>
          </div>
        </div>
        <div class="start-apps">
          <div class="start-app" data-app="notepad" onclick="openNotepad()">
            <span class="app-icon">üìù</span>
            <span class="app-name">Pozn√°mkov√Ω blok</span>
          </div>
          <div class="start-app" data-app="settings" onclick="openSettings()">
            <span class="app-icon">‚öôÔ∏è</span>
            <span class="app-name">Nastaven√≠</span>
          </div>
          <div class="start-app" data-app="quiz" onclick="openQuiz()">
            <span class="app-icon">üß©</span>
            <span class="app-name">S√≠to hesel</span>
          </div>
          <div class="start-app" data-app="wifi" onclick="openWifiTask()">
            <span class="app-icon">üì∂</span>
            <span class="app-name">Wi-Fi p≈ô√≠zraky</span>
          </div>
          <div class="start-app" data-app="phish" onclick="openPhishingTask()">
            <span class="app-icon">üé£</span>
            <span class="app-name">Lov phishingu</span>
          </div>
          <div class="start-app" data-app="fa" onclick="open2FATask()">
            <span class="app-icon">üîê</span>
            <span class="app-name">Dvoufaktorov√° br√°na</span>
          </div>
          <div class="start-app" data-app="file" onclick="openFileTask()">
            <span class="app-icon">üìÅ</span>
            <span class="app-name">Souborov√° past</span>
          </div>
          <div class="start-app" data-app="privacy" onclick="openPrivacyTask()">
            <span class="app-icon">üõ°Ô∏è</span>
            <span class="app-name">≈†t√≠t soukrom√≠</span>
          </div>
        </div>
        <div class="start-footer">
          <div class="power-btn" onclick="showLogoutConfirm()">
            <span class="power-icon">‚èª</span>
            <span class="power-text">Odhl√°sit</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTES MODAL -->
  <div class="notes-modal hidden" id="notesModal">
    <div class="notes-content">
      <div class="notes-header">
        <h3>üìù Pozn√°mky pro p≈ôihl√°≈°en√≠</h3>
        <button class="close-btn" onclick="hideNotes()">√ó</button>
      </div>
      <div class="notes-body">
        <p><strong>V√≠tej na 666. z√°kladn√≠ ≈°kole</strong> ‚Äì jen vyvolen√≠ mohou vstoupit do syst√©mu.</p>
        <p>Tv≈Øj login v≈ædy zaƒç√≠n√° ƒç√≠slem <strong>666.</strong>, za n√≠m p√≠≈°e≈° ƒç√°st sv√©ho p≈ô√≠jmen√≠ a k≈ôestn√≠ho jm√©na.</p>
        <p><strong>Nap≈ô√≠klad ≈ôeditel Pavel ≈†ulc se p≈ôihla≈°uje takto:</strong><br>
        login: <code>666.sulcpa</code><br>
        email: <code>sulcpa@zs666.peklo-edu.cz</code></p>
        <p><strong>Tvoje heslo je:</strong> <code>afRikA+66.</code></p>
        <p><em>Neus√≠nej na vav≈ô√≠nech ‚Äì tenhle kl√≠ƒç brzy ztrat√≠ platnost a syst√©m tƒõ donut√≠ vytvo≈ôit nov√©, silnƒõj≈°√≠ heslo.</em></p>
        <p><strong>Pamatuj:</strong> kdo nedodr≈æ√≠ pravidla, ten br√°nu ≈°koly neotev≈ôe.</p>
      </div>
    </div>
  </div>

  <!-- SYSTEM MODAL (univerz√°ln√≠ pro ‚öôÔ∏è/üîã/üì∂) -->
  <div class="sys-modal hidden" id="sysModal" role="dialog" aria-modal="true" aria-labelledby="sysTitle">
    <div class="sys-card">
      <div class="sys-head">
        <h3 id="sysTitle">System</h3>
        <button class="sys-close" type="button" onclick="closeSys()">√ó</button>
      </div>
      <div class="sys-body" id="sysBody"></div>
    </div>
  </div>

  <!-- OVERLAY pro expiraci / zmƒõnu hesla -->
  <div class="overlay hidden" id="pwdOverlay">
    <!-- Expirace -->
    <div class="glass-card" id="pwdExpire">
      <h2>Platnost hesla vypr≈°ela</h2>
      <p>Pro pokraƒçov√°n√≠ je nutn√© zadat nov√© heslo.</p>
      <div style="text-align:right;margin-top:16px;">
        <button class="btn-secondary" onclick="cancelPwd()">Storno</button>
        <button class="btn-primary" onclick="showPwdChange()">OK</button>
      </div>
    </div>

    <!-- Formul√°≈ô zmƒõny hesla -->
    <div class="glass-card hidden" id="pwdChange">
      <h2>Zmƒõna hesla</h2>
      <input id="pwdNew" type="password" placeholder="Nov√© heslo" oninput="validatePwd()">
      <input id="pwdNew2" type="password" placeholder="Potvrƒè heslo" oninput="validatePwd()">
      <div class="meter"><i id="pwdMeter"></i></div>
      <ul class="rule-list" id="rules">
        <li data-r="len">Min. 10 znak≈Ø</li>
        <li data-r="case">Velk√© i mal√© p√≠smeno</li>
        <li data-r="num">ƒå√≠slo</li>
        <li data-r="sym">Speci√°ln√≠ znak</li>
        <li data-r="old">Dost odli≈°n√© od star√©ho (min. 3 zmƒõny; ne jen p≈ôidat znak)</li>
        <li data-r="match">Shoda hesel</li>
      </ul>
      <div style="text-align:right;margin-top:12px;">
        <button class="btn-primary" id="pwdSave" onclick="savePwd()" disabled>Ulo≈æit</button>
      </div>
      <div id="pwdErr" style="margin-top:8px;color:#ffcccc;font-size:14px;"></div>
    </div>
  </div>

  <script>
    // Unified password fragments system
    window.finalKeyParts = Object.assign(window.finalKeyParts || {}, { ev:null, ro:null, pa:null, plus:null, school:null, month:null });

    function setPart(k,v){
      window.finalKeyParts[k] = String(v);
      try{ dispatchEvent(new CustomEvent('final:changed',{detail:{k,v}})); }catch(_){}
    }
    
    // Compatibility proxy for existing code
    function storeKeyPart(k,v){ setPart(k,v); }

    function monthMM(d=new Date()){ const m=d.getMonth()+1; return (m<10?'0':'')+m; }

    function buildFinalPassword(){
      // slo≈æ EVROPA z d√≠lk≈Ø (pokud nƒõkter√Ω d√≠lek chyb√≠, pou≈æij pr√°zdn√Ω string)
      const ev = (finalKeyParts.ev||'').toString();
      const ro = (finalKeyParts.ro||'').toString();
      const pa = (finalKeyParts.pa||'').toString();
      const region = (ev + ro + pa).toUpperCase(); // oƒçek√°v√°me EVROPA
      // matematick√© znam√©nko - ulo≈æeno jako text (nap≈ô. '+' nebo 'PLUS' nebo 'matematick√© znam√©nko')
      const sign = (finalKeyParts.plus && String(finalKeyParts.plus).trim()) ? String(finalKeyParts.plus) : '+';
      // school number pevnƒõ: 777 (ulo≈æen√≠ √∫kolu wifi by mƒõl volat storeKeyPart('school','777'))
      const school = finalKeyParts.school || '777';
      const fixed = '111';
      const mm = finalKeyParts.month || (new Date().getMonth()+1).toString().padStart(2,'0');
      return String(region + sign + school + fixed + mm);
    }
    
    // Compatibility aliases
    function buildFinalTarget(){ return buildFinalPassword(); }
    function checkFinalInput(input){
      const t = buildFinalPassword().toUpperCase();
      const v = String(input||'').replace(/\s+/g,'').toUpperCase();
      return v===t;
    }
    
    /* jednoduch√° kontrola, zda m√°me v≈°echny netrivi√°ln√≠ d√≠lky (MM se ber tady jako dynamick√©) */
    function hasAllKeyParts(){
      const need = ['ev','ro','pa','plus','school'];
      return need.every(k => !!finalKeyParts[k]);
    }

    function getFinalProgress(){
      const need=['ev','ro','pa','plus','school'];
      const have=need.filter(k=>!!window.finalKeyParts[k]).length;
      return {have, need:need.length, done:have===need.length};
    }

    function showFinalProgress(){
      const p=getFinalProgress();
      alert(
        `D√≠lky: ${p.have}/${p.need}\n`+
        `Region: ${(window.finalKeyParts.ev||'__')+(window.finalKeyParts.ro||'__')+(window.finalKeyParts.pa||'__')}\n`+
        `Znak: ${window.finalKeyParts.plus?'+':'(chyb√≠)'}\n`+
        `≈†kola: ${window.finalKeyParts.school||'(?)'}\n`+
        `Mƒõs√≠c: ${(window.finalKeyParts.month||monthMM())}\n`+
        `C√≠l: ${buildFinalTarget()}`
      );
    }

    // Hodiny a datum na lock screenu
    const timeEl = document.getElementById('lockTime');
    const dateEl = document.getElementById('lockDate');
    const CZ_DAYS = ['nedƒõle','pondƒõl√≠','√∫ter√Ω','st≈ôeda','ƒçtvrtek','p√°tek','sobota'];
    const CZ_MONTHS = ['ledna','√∫nora','b≈ôezna','dubna','kvƒõtna','ƒçervna','ƒçervence','srpna','z√°≈ô√≠','≈ô√≠jna','listopadu','prosince'];
    function tick(){
      const d=new Date();
      timeEl.textContent = d.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'});
      dateEl.textContent = `${CZ_DAYS[d.getDay()]} ${d.getDate()}. ${CZ_MONTHS[d.getMonth()]}`;
    }
    setInterval(tick, 1000); tick();

    // Wallpaper configuration
    const WALLPAPER_JSON_URL = 'https://example.com/wallpaper-config.json'; // Change this URL
    
    async function loadWallpaper() {
      try {
        const response = await fetch(WALLPAPER_JSON_URL);
        const config = await response.json();
        if (config.wallpaper_url) {
          document.documentElement.style.setProperty('--custom-wallpaper', `url(${config.wallpaper_url})`);
          const desktop = document.querySelector('.desktop');
          if (desktop) desktop.classList.add('custom-bg');
        }
      } catch (e) {
        console.log('Using default wallpaper');
      }
    }
    
    // Load wallpaper when desktop is shown
    addEventListener('DOMContentLoaded', loadWallpaper);

    function show(el){ 
      const element = document.getElementById(el);
      element.classList.remove('hidden');
      element.classList.add('slide-in');
    }
    
    function hide(el){ 
      const element = document.getElementById(el);
      element.classList.add('slide-out');
      setTimeout(() => {
        element.classList.add('hidden');
        element.classList.remove('slide-out', 'slide-in');
      }, 800);
    }

    // P≈ôechod 1: Lock ‚Üí Login (klik nebo Enter)
    const lockScreen = document.getElementById('lockScreen');
    function goLogin(){ 
      hide('lockScreen'); 
      setTimeout(() => {
        show('loginScreen'); 
        setTimeout(()=>document.getElementById('password').focus(), 200);
      }, 400);
    }
    lockScreen.addEventListener('click', goLogin);
    lockScreen.addEventListener('keydown', (e)=>{ if(e.key==='Enter') goLogin(); });

    // P≈ôechod 2: Login ‚Üí Pr√°zdn√° plocha (Enter nebo klik na ≈°ipku). Bez kontroly hesla.
    const pass = document.getElementById('password');
    document.getElementById('btnGo').addEventListener('click', proceed);
    pass.addEventListener('keydown', e=>{ if(e.key==='Enter') proceed(); });
    
    // Funkce pro jin√©ho u≈æivatele
    document.getElementById('btnGoOther').addEventListener('click', proceed);
    document.getElementById('username').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('otherPassword').focus(); });
    document.getElementById('otherPassword').addEventListener('keydown', e=>{ if(e.key==='Enter') proceed(); });
    
    // Funkce pro zobrazen√≠/skryt√≠ hesla
    function togglePasswordVisibility(inputId, eyeBtnId) {
      const input = document.getElementById(inputId);
      const eyeBtn = document.getElementById(eyeBtnId);
      
      if (input.type === 'password') {
        input.type = 'text';
        eyeBtn.textContent = 'üôà';
        eyeBtn.setAttribute('aria-label', 'Skr√Ωt heslo');
      } else {
        input.type = 'password';
        eyeBtn.textContent = 'üëÅ';
        eyeBtn.setAttribute('aria-label', 'Zobrazit heslo');
      }
    }
    
    // Funkce pro zobrazen√≠/skryt√≠ oƒç√≠ƒçka podle obsahu hesla
    function toggleEyeVisibility(inputId, eyeBtnId) {
      const input = document.getElementById(inputId);
      const eyeBtn = document.getElementById(eyeBtnId);
      
      if (input.value.length > 0) {
        eyeBtn.classList.add('visible');
      } else {
        eyeBtn.classList.remove('visible');
        // Resetovat typ na password kdy≈æ je pr√°zdn√©
        input.type = 'password';
        eyeBtn.textContent = 'üëÅ';
        eyeBtn.setAttribute('aria-label', 'Zobrazit heslo');
      }
    }
    
    // P≈ôid√°n√≠ event listener≈Ø pro oƒç√≠ƒçka
    document.getElementById('eyeBtn').addEventListener('click', () => {
      togglePasswordVisibility('password', 'eyeBtn');
    });
    
    document.getElementById('eyeBtnOther').addEventListener('click', () => {
      togglePasswordVisibility('otherPassword', 'eyeBtnOther');
    });
    
    // Sledov√°n√≠ zmƒõn v heslov√©m poli
    document.getElementById('password').addEventListener('input', () => {
      toggleEyeVisibility('password', 'eyeBtn');
    });
    
    document.getElementById('otherPassword').addEventListener('input', () => {
      toggleEyeVisibility('otherPassword', 'eyeBtnOther');
    });
    
    function proceed() {
      const currentUser = document.querySelector('.username').textContent;
      let username, password;
      let errorElement;
      
      if (currentUser === 'Administrator') {
        // Administrator m√° heslo 12345678
        password = document.getElementById('password').value;
        if (password === '12345678') {
          hide('loginScreen'); 
          setTimeout(() => { show('desktopScreen'); enableRedFX(); }, 400);
          return;
        } else {
          document.getElementById('errorMsg').textContent = 'Nespr√°vn√© heslo pro Administratora.';
          return;
        }
      } else if (document.getElementById('otherUserForm').classList.contains('hidden')) {
        // Norm√°ln√≠ u≈æivatel Jan Nov√°k
        password = document.getElementById('password').value;
        document.getElementById('errorMsg').textContent = 'P≈ô√≠stup odep≈ôen. Zkuste jin√©ho u≈æivatele.';
        return;
      } else {
        // Jin√Ω u≈æivatel - kontrola 666. loginu a hesla
        username = document.getElementById('username').value;
        password = document.getElementById('otherPassword').value;
        errorElement = document.getElementById('errorMsgOther');
        
        // Kontrola loginu
        const isValidLogin = username.startsWith('666.') && username.length > 4;
        const isValidEmail = username.includes('@zs666.peklo-edu.cz') && !username.startsWith('@');
        const isValidPassword = password === 'afRikA+66.';
        
        if (!isValidLogin && !isValidEmail) {
          errorElement.textContent = 'Login mus√≠ zaƒç√≠nat "666." nebo b√Ωt email konƒç√≠c√≠ "@zs666.peklo-edu.cz"';
          return;
        }
        
        if (!isValidPassword) {
          errorElement.textContent = 'Nespr√°vn√© heslo. Zkontroluj pozn√°mky.';
          return;
        }
        
        // √öspƒõ≈°n√© p≈ôihl√°≈°en√≠ - ale nejprve zkontrolovat expiraci hesla
        openPwdExpire(username, password);
      }
    }
    
    function showDomainHelp() {
      openSys('Dom√©nov√° pomoc', '<p>Pro p≈ôihl√°≈°en√≠ k jin√© dom√©nƒõ kontaktujte spr√°vce syst√©mu na ƒç√≠sle <strong>378 03 5555</strong>.</p>');
    }
    
    // System modal helpers
    function openSys(title, html){
      const m = document.getElementById('sysModal');
      document.getElementById('sysTitle').textContent = title;
      document.getElementById('sysBody').innerHTML = html;
      m.classList.remove('hidden');
    }
    
    function closeSys(){ 
      document.getElementById('sysModal').classList.add('hidden'); 
    }

    function notifyNext(msg){
      let extra = '';
      if (typeof getFinalProgress === 'function') {
        const p = getFinalProgress();
        extra = `<p style="opacity:.8">D√≠lky hesla: <b>${p.have}/${p.need}</b></p>`;
      }
      openSys('Pokraƒçuj', `<p>${msg || '√ökol je splnƒõn.'}</p><p>Dal≈°√≠ √∫kol najde≈° v nab√≠dce Start.</p>${extra}`);
    }

    window.openNextTask = function(){
      notifyNext();
    };
    
    function showSettingsInfo(){
      openSys('‚öôÔ∏è Nastaven√≠',
        `<p>P≈ô√≠stup k&nbsp;nastaven√≠ je z bezpeƒçnostn√≠ch d≈Øvod≈Ø uzamƒçen.</p>
         <p>Nejprve ovƒõ≈ô svoji identitu.</p>
         <p><em>Chce≈° mƒõnit syst√©m? Nejprve mus√≠≈° dok√°zat, ≈æe sem opravdu pat≈ô√≠≈°.</em></p>`);
    }

    function showNetworkInfo(){
      openSys('üì∂ Internetov√© p≈ôipojen√≠',
        `<p>S√≠≈• <strong>PEKLO-NET</strong> je dostupn√°.</p>
         <p>P≈ô√≠stup povolen jen pro p≈ôihl√°≈°en√© u≈æivatele.</p>
         <p>Dal≈°√≠ nalezeno: <code>Shadow666</code>. Bez hesla se dovnit≈ô nedostane≈°.</p>`);
    }

    function showBatteryInfo(){
      openSys('üîã Baterie',
        `<p>√örove≈à: <strong>666&nbsp;%</strong></p>
         <p><em>Energie pekeln√© ≈°koly nikdy nedojde.</em></p>`);
    }
    
    function showNotes() {
      document.getElementById('notesModal').classList.remove('hidden');
    }
    
    function hideNotes() {
      document.getElementById('notesModal').classList.add('hidden');
    }
    
    // P≈ôep√≠n√°n√≠ u≈æivatel≈Ø
    function switchUser(userType) {
      const usernames = {
        'admin': 'Administrator',
        'other': 'Jin√Ω u≈æivatel',
        'user': 'Jan Nov√°k'
      };
      
      const currentUser = usernames[userType] || 'Jan Nov√°k';
      document.querySelector('.username').textContent = currentUser;
      document.getElementById('password').value = '';
      
      // Skr√Ωt oƒç√≠ƒçko kdy≈æ se vyma≈æe heslo
      document.getElementById('eyeBtn').classList.remove('visible');
      
      // Vymazat chybov√© zpr√°vy
      document.getElementById('errorMsg').textContent = '';
      document.getElementById('errorMsgOther').textContent = '';
      
      // Zmƒõna avataru podle u≈æivatele
      const avatarEmojis = {
        'Administrator': 'üë®‚Äçüíº',
        'Jin√Ω u≈æivatel': '‚ùì',
        'Jan Nov√°k': 'üë®‚Äçüíª'
      };
      document.querySelector('.avatar').textContent = avatarEmojis[currentUser] || 'üë§';
      
      // P≈ôep√≠n√°n√≠ mezi norm√°ln√≠m a roz≈°√≠≈ôen√Ωm formul√°≈ôem
      if (userType === 'other') {
        document.getElementById('normalLogin').classList.add('hidden');
        document.getElementById('otherUserForm').classList.remove('hidden');
        setTimeout(() => document.getElementById('username').focus(), 100);
      } else {
        document.getElementById('normalLogin').classList.remove('hidden');
        document.getElementById('otherUserForm').classList.add('hidden');
        setTimeout(() => document.getElementById('password').focus(), 100);
      }
    }

    // Aktualizace ƒçasu na desktopu
    function updateDesktopTime() {
      const desktopTimeEl = document.getElementById('desktopTime');
      if (desktopTimeEl) {
        const d = new Date();
        desktopTimeEl.textContent = d.toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'});
      }
    }
    setInterval(updateDesktopTime, 1000);
    
    // Desktop funkce
    function toggleStartMenu() {
      const startMenu = document.getElementById('startMenu');
      startMenu.classList.toggle('hidden');
    }
    
    function openFileExplorer() {
      document.getElementById('startMenu').classList.add('hidden');
      openSys('üìÅ Pr≈Øzkumn√≠k soubor≈Ø', '<p>Pr≈Øzkumn√≠k soubor≈Ø se naƒç√≠t√°...</p><p><em>P≈ô√≠stup k nƒõkter√Ωm slo≈æk√°m m≈Ø≈æe b√Ωt omezen.</em></p>');
    }
    
    function openNotepad() {
      document.getElementById('startMenu').classList.add('hidden');
      openSys('üìù Pozn√°mkov√Ω blok', '<p>Tady je seps√°no v≈°e, co zapomene≈° 5 sekund po zav≈ôen√≠ t√©to obrazovky.</p>');
    }
    
    function openCalculator() {
      document.getElementById('startMenu').classList.add('hidden');
      openSys('üßÆ Kalkulaƒçka', '<p>Kalkulaƒçka se naƒç√≠t√°...</p><p><em>Z√°kladn√≠ matematick√© operace.</em></p>');
    }
    
    function openSettings() {
      document.getElementById('startMenu').classList.add('hidden');
      openSys('‚öôÔ∏è Nastaven√≠', '<p>Nastaven√≠ syst√©mu se naƒç√≠t√°...</p><p><em>P≈ô√≠stup k pokroƒçil√Ωm nastaven√≠m je omezen.</em></p>');
    }
    
    function openRecycleBin() {
      openSys('üóëÔ∏è Ko≈°', '<p>Ko≈° je pr√°zdn√Ω.</p><p><strong>Varov√°n√≠:</strong> Tento odpad nen√≠ recyklovateln√Ω. Jsou to jen tvoje ≈°patn√° rozhodnut√≠.</p>');
    }
    
    function openSecretFolder() {
      openSys('üìÇ Tajn√© soubory', '<p>üîí P≈ô√≠stup odep≈ôen</p><p><em>Fajn, pod√≠vej se. Ale jestli se to proval√≠, tak j√° jsem jenom text a ty jsi ten, kdo to kliknul.</em></p>');
    }
    
    function showLogoutConfirm() {
      document.getElementById('startMenu').classList.add('hidden');
      openSys('Odhl√°≈°en√≠', '<p>Opravdu se chcete odhl√°sit?</p><p><em>V≈°echny neulo≈æen√© zmƒõny budou ztraceny.</em></p><div style="text-align:right;margin-top:16px;"><button onclick="closeSys()" style="all:unset;cursor:pointer;border-radius:6px;padding:8px 12px;background:rgba(0,0,0,.1);color:#666;margin-right:8px;">Zru≈°it</button><button onclick="doLogout()" style="all:unset;cursor:pointer;border-radius:6px;padding:8px 12px;background:#dc3545;color:#fff;">Odhl√°sit</button></div>');
    }
    
    function doLogout() {
      closeSys();
      hide('desktopScreen');
      setTimeout(() => {
        show('loginScreen');
        // Vyƒçistit formul√°≈ôe ale zachovat u≈æivatele
        document.getElementById('password').value = '';
        document.getElementById('otherPassword').value = '';
        document.getElementById('username').value = '';
        document.getElementById('errorMsg').textContent = '';
        document.getElementById('errorMsgOther').textContent = '';
        // Skr√Ωt oƒç√≠ƒçka
        document.getElementById('eyeBtn').classList.remove('visible');
        document.getElementById('eyeBtnOther').classList.remove('visible');
        // Zamƒõ≈ôit na heslo
        setTimeout(() => document.getElementById('password').focus(), 200);
      }, 400);
    }
    
    // Password expiration functions
    let _expLogin = '';
    let _expOldPass = '';

    function openPwdExpire(login, oldPass){
      _expLogin = login; _expOldPass = oldPass;
      document.getElementById('pwdOverlay').classList.remove('hidden');
      document.getElementById('pwdExpire').classList.remove('hidden');
      document.getElementById('pwdChange').classList.add('hidden');
      document.body.classList.add('modal-open');
    }
    
    function cancelPwd(){
      document.getElementById('pwdOverlay').classList.add('hidden');
      document.body.classList.remove('modal-open');
      setTimeout(()=>{ hide('desktopScreen'); show('loginScreen'); },300);
    }
    
    function showPwdChange(){
      document.getElementById('pwdExpire').classList.add('hidden');
      document.getElementById('pwdChange').classList.remove('hidden');
      ['pwdNew','pwdNew2'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('pwdErr').textContent='';
      document.querySelectorAll('#rules li').forEach(li=>li.classList.remove('ok'));
      document.getElementById('pwdMeter').style.width='0%';
      document.getElementById('pwdSave').disabled=true;
      setTimeout(()=>document.getElementById('pwdNew').focus(),50);
    }
    
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    // Levenshtein ‚Äì kolik √∫prav je pot≈ôeba k p≈ôevodu ≈ôetƒõzce A‚ÜíB
    function levenshtein(a,b){
      a=String(a||''); b=String(b||'');
      const m=a.length, n=b.length;
      const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i-1][j]+1,     // delete
            dp[i][j-1]+1,     // insert
            dp[i-1][j-1]+cost // replace
          );
        }
      }
      return dp[m][n];
    }

    // Je nov√© heslo jen trivi√°ln√≠ varianta star√©ho?
    function isTrivialVariant(oldP,newP){
      if(!oldP || !newP) return false;
      const o=String(oldP).toLowerCase();
      const n=String(newP).toLowerCase();

      // star√© je pod≈ôetƒõzec nov√©ho (p≈ôid√°n znak/znaky na zaƒç./konci)
      if(n.includes(o)) return true;

      // star√© ¬± 1‚Äì2 znaky na zaƒç./konci (rychl√Ω check)
      const end = new RegExp('^'+escapeRegExp(o)+'[\\s\\S]{1,2}$');
      const beg = new RegExp('^[\\s\\S]{1,2}'+escapeRegExp(o)+'$');
      if(end.test(n) || beg.test(n)) return true;

      // p≈ô√≠li≈° podobn√©: m√©nƒõ ne≈æ 3 √∫pravy (vlo≈æit/smazat/nahradit)
      return levenshtein(o,n) < 3;
    }

    function validatePwd(){
      const p = document.getElementById('pwdNew').value;
      const p2 = document.getElementById('pwdNew2').value;

      const tooSimilar = isTrivialVariant(_expOldPass, p);

      const rules = {
        len:  p.length >= 10,
        case: /[A-Z]/.test(p) && /[a-z]/.test(p),
        num:  /\d/.test(p),
        sym:  /[^A-Za-z0-9]/.test(p),
        match: p && p === p2,
        // m√≠sto "nen√≠ stejn√©" teƒè vynucujeme "nen√≠ trivi√°ln√≠ varianta"
        old:  p && !tooSimilar
      };

      let score=0;
      Object.entries(rules).forEach(([k,v])=>{
        const el=document.querySelector(`#rules [data-r="${k}"]`);
        el.classList.toggle('ok', v);
        if(v) score+=Math.round(100/6);
      });

      document.getElementById('pwdMeter').style.width=Math.min(score,100)+'%';
      document.getElementById('pwdSave').disabled = score < 100;

      // dopl≈à vysvƒõtlen√≠, kdy≈æ je probl√©m pr√°vƒõ v "old"
      const err = document.getElementById('pwdErr');
      if(!rules.old && p){
        err.textContent = 'Nov√© heslo je p≈ô√≠li≈° podobn√© star√©mu (zkus v√≠c zmƒõn ne≈æ jen p≈ôidat znak).';
      } else if(!rules.match && p2){
        err.textContent = 'Hesla se neshoduj√≠.';
      } else {
        err.textContent = '';
      }
    }
    
    function savePwd(){
      if(document.getElementById('pwdSave').disabled) return;
      document.getElementById('pwdErr').textContent='Heslo mƒõn√≠me‚Ä¶';
      setTimeout(()=>{
        document.getElementById('pwdOverlay').classList.add('hidden');
        document.body.classList.remove('modal-open');
        hide('loginScreen'); 
        setTimeout(()=>{
          show('desktopScreen');
          enableRedFX();
          updateDesktopTime();
          startTimer(25);
          
          // Aktualizovat jm√©no u≈æivatele na desktopu
          const desktopUserName = document.getElementById('desktopUserName');
          if (_expLogin.includes('@')) {
            const username = _expLogin.split('@')[0];
            desktopUserName.textContent = username;
          } else if (_expLogin.startsWith('666.')) {
            desktopUserName.textContent = _expLogin;
          } else {
            desktopUserName.textContent = _expLogin;
          }
        },300);
      },700);
    }
    
    // Timer v prav√©m horn√≠m rohu
    function startTimer(minutes=25){
      const el=document.createElement('div'); el.className='timer'; el.id='gameTimer';
      document.body.appendChild(el);
      let t=minutes*60;
      const tick=()=>{ const mm=String(Math.floor(t/60)).padStart(2,'0'); const ss=String(t%60).padStart(2,'0'); el.textContent=`‚è± ${mm}:${ss}`; if(t--<=0){ clearInterval(iv); el.style.background='rgba(200,50,50,.9)'; showTimeoutEvent(); } };
      tick(); const iv=setInterval(tick,1000);
    }
    function showTimeoutEvent(){ openSys('Upozornƒõn√≠','ƒåas vypr≈°el ‚Äî pekeln√© zjeven√≠ stahuje obrazovku...'); }
    
    function enableRedFX(){
      if (!document.querySelector('.redfx')) {
        const fx = document.createElement('div');
        fx.className = 'redfx';
        document.body.appendChild(fx);
      }
      // v√Ωrazn√° hl√°≈°ka p≈ôes horn√≠ banner
      showBreach('‚ö†Ô∏è POƒå√çTAƒåOV√Å S√ç≈§ BYLA NAPADENA. Otev≈ôi Start a pl≈à bezpeƒçnostn√≠ √∫koly.');
    }

    function showBreach(msg){
      let n = document.querySelector('.wallpaper-note');
      if (!n) {
        n = document.createElement('div');
        n.className = 'wallpaper-note warn';
        document.body.appendChild(n);
      }
      n.style.opacity = '1';
      n.textContent = msg;
      // postupn√© zmizen√≠
      setTimeout(()=>{ n.style.transition='opacity .6s'; n.style.opacity='0'; }, 5200);
      setTimeout(()=>{ n.remove?.(); }, 6000);
    }
    
    // Zav≈ôen√≠ start menu p≈ôi kliknut√≠ mimo nƒõj
    document.addEventListener('click', (e) => {
      const startMenu = document.getElementById('startMenu');
      const startBtn = document.querySelector('.start-btn');
      
      if (!startMenu.classList.contains('hidden') && 
          !startMenu.contains(e.target) && 
          !startBtn.contains(e.target)) {
        startMenu.classList.add('hidden');
      }
    });

    // ESC pro n√°vrat na √∫vodn√≠ obrazovku nebo zav≈ôen√≠ pozn√°mek
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Pokud je otev≈ôen√Ω password overlay, zav≈ôi ho
        if (!document.getElementById('pwdOverlay').classList.contains('hidden')) {
          cancelPwd();
          return;
        }
        // Pokud je otev≈ôen√Ω system modal, zav≈ôi ho
        if (!document.getElementById('sysModal').classList.contains('hidden')) {
          closeSys();
          return;
        }
        // Pokud jsou otev≈ôen√© pozn√°mky, zav≈ôi je
        if (!document.getElementById('notesModal').classList.contains('hidden')) {
          hideNotes();
          return;
        }
        // Pokud je otev≈ôen√© start menu, zav≈ôi ho
        if (!document.getElementById('startMenu').classList.contains('hidden')) {
          document.getElementById('startMenu').classList.add('hidden');
          return;
        }
        // Jinak skr√Ωt v≈°echny obrazovky
        hide('loginScreen');
        hide('desktopScreen');
        // Zobrazit √∫vodn√≠ obrazovku
        setTimeout(() => show('lockScreen'), 400);
      }
    });

    (function(){
    const base = ['quiz','wifi','file'], late = ['privacy','fa'];

    // u≈æ ≈æ√°dn√© state.parts ‚Äì jedin√Ω zdroj pravdy je window.finalKeyParts
    let state = { done: new Set(), note: 'ƒå√ÅSTI HESLA\n' };

    // (≈æ√°dn√© window.setPart ani window.buildFinalPassword uvnit≈ô IIFE!)
    function ensureDesktop(){
      const d = document.querySelector('.desktop-icons');
      if(!d) return;

      // 1) Jedin√° ikona ƒåTIMNƒö.txt
      if(!document.getElementById('readme-note')){
        const n = document.createElement('div');
        n.id = 'readme-note';
        n.className = 'desktop-icon';
        n.innerHTML = '<div class="icon-image">üìÑ</div><div class="icon-label">ƒåTIMNƒö.txt</div>';
        n.ondblclick = () => openNoteWindow();
        d.appendChild(n);
      }

      // 2) ‚ÄûTento poƒç√≠taƒç" (pokud chce≈°)
      if(![...d.children].some(x=>/Tento poƒç√≠taƒç/i.test(x.textContent))){
        const pc=document.createElement('div');
        pc.className='desktop-icon';
        pc.innerHTML='<div class="icon-image">üíª</div><div class="icon-label">Tento poƒç√≠taƒç</div>';
        pc.ondblclick=()=>openSys('Tento poƒç√≠taƒç','<p><b>Autor:</b> Mgr. Patrik Vanƒõk<br>vanek@canvaveskole.com<br><a href="https://www.canvaveskole.com" target="_blank" rel="noopener noreferrer" style="color:#2bc4d0;text-decoration:underline;">www.canvaveskole.com</a></p><p><b>S√≠≈•:</b> SSID: PEKLO-NET ‚Ä¢ DHCP: 666.0.0.1 ‚Ä¢ Br√°na: 66.6.66.1 ‚Ä¢ DNS: 13.13.13.13</p><p><b>Segmenty:</b> HellLab-24 ‚Ä¢ ShadowGrid-48 ‚Ä¢ TeacherCore-12</p>');
        d.prepend(pc);
      }

      // 3) Fin√°ln√≠ z√°mek (pouze pokud jsou v≈°echny √∫koly hotov√©)
      if(state.done.size >= 5 && !document.getElementById('final-lock-icon')){
        const lock = document.createElement('div');
        lock.id = 'final-lock-icon';
        lock.className = 'desktop-icon final-lock';
        lock.innerHTML = '<div class="icon-image">üîê</div><div class="icon-label">Fin√°ln√≠ z√°mek</div>';
        lock.ondblclick = () => openFinalLock();
        lock.style.cssText = 'position:fixed;right:20px;top:20px;z-index:1000;animation:lockPulse 2s infinite;';
        document.body.appendChild(lock);
      }
    }

    // textov√° ‚Äûdatab√°ze" pozn√°mky
    let _readmeText = 'ƒå√ÅSTI HESLA\n\nMus√≠≈° naj√≠t skryt√© √∫koly, splnit je a opƒõt obnovit bezpeƒçnostn√≠ protokol pekeln√© ≈°koly!\n';

    // otev≈ô√≠t a uk√°zat aktu√°ln√≠ obsah
    function openNoteWindow(){
      openSys('ƒåTIMNƒö.txt', '<pre style="white-space:pre-wrap">'+_readmeText+'</pre>');
    }

    // p≈ôid√°v√°n√≠ ≈ô√°dk≈Ø do existuj√≠c√≠ pozn√°mky (bez vytv√°≈ôen√≠ nov√© ikony)
    function addDesktopNote(line){
      if(line) _readmeText += '\n' + line;
      ensureDesktop();
    }
    
    // Export pro pou≈æit√≠ mimo IIFE
    window.addDesktopNote = addDesktopNote;

    function appendNote(line){addDesktopNote(line);}
    function redFX(){if(document.querySelector('.redfx'))return;document.body.appendChild(Object.assign(document.createElement('div'),{className:'redfx'}))}
    function cap(s){return s.charAt(0).toUpperCase()+s.slice(1)}
    function refreshStart(){
      const flow = ['quiz','wifi','file','phish','privacy','fa']; // po≈ôad√≠
      const menu = [...document.querySelectorAll('.start-app[data-app]')];

      // kdo je dal≈°√≠
      const nextId = flow.find(id => !state.done.has(id));

      menu.forEach(item => {
        const id = item.dataset.app;
        if(!flow.includes(id)) return; // syst√©mov√© vƒõci (notepad, settings) ne≈ôe≈°√≠me

        // v√Ωchoz√≠: zamknout
        item.classList.remove('done','pulse');
        item.classList.toggle('locked', true);
        item.onclick = () => {};

        // hotov√©
        if(state.done.has(id)){
          item.classList.remove('locked');
          item.classList.add('done');     // zelen√© podbarven√≠
          return;
        }

        // pr√°vƒõ dal≈°√≠ je aktivn√≠
        if(id === nextId){
          item.classList.remove('locked');
          const fn = window['open' + id.charAt(0).toUpperCase() + id.slice(1) + (id==='quiz'?'':'Task')];
          item.onclick = () => { if(typeof fn==='function') fn(); };
        }
      });
    }
    function startFlow(){
     const first=base[Math.floor(Math.random()*base.length)];
     state.startFirst=first; refreshStart(); redFX(); ensureDesktop();
    }



    /* p≈ôid√°n√≠ hotov√©ho √∫kolu
       vol√° se z jednotliv√Ωch scoreX() p≈ôes token mapov√°n√≠ */
    window.unlock = function(token){
      const map = {'EV':'quiz','777':'wifi','+':'file','PA':'privacy','RO':'phish','2FA':'fa'};
      const id = map[token] || token;          // povol i p≈ô√≠m√© vol√°n√≠ unlock('quiz')

      if(!id) return;

      // zapi≈° stav
      state.done.add(id);

      // force refresh desktop -> vytvo≈ô√≠ fin√°ln√≠ ikonku pokud je hotovo >=5
      try { addDesktopNote(''); } catch(e) { /* fallback: nic */ }

      // zelen√Ω ‚Äûpulse"
      const el = document.querySelector(`.start-app[data-app="${id}"]`);
      if(el){
        el.classList.add('done');
        el.classList.remove('locked');
        el.classList.add('pulse');
        setTimeout(()=>el.classList.remove('pulse'), 900);
      }

      // p≈ôepoƒç√≠tej dostupnost dal≈°√≠ch
      refreshStart();
    };
    ['DOMContentLoaded','load'].forEach(e=>addEventListener(e,()=>{
     const mo=new MutationObserver(()=>{if(!document.getElementById('desktopScreen').classList.contains('hidden')){startFlow();mo.disconnect()}});
     mo.observe(document.body,{subtree:true,attributes:true});
    }));
    // Bezpeƒçn√° glob√°ln√≠ funkce pro udƒõlov√°n√≠ peƒçet√≠
    window.grantSeal = function(name, part){
      try {
        window.addDesktopNote && window.addDesktopNote('PEƒåE≈§: ' + name + (part ? (' ['+part+']') : ''));
      } catch(e) { /* no-op */ }
    };
    window.showToast=window.showToast||function(){};
    const _pOpen=window.openPhishingTask; window.openPhishingTask=function(){ if(!base.every(b=>state.done.has(b))) return; _pOpen?_pOpen():void 0 };
    const _pScore=window.scorePhish; window.scorePhish=function(){ const was=document.querySelectorAll('.start-app').length; _pScore&&_pScore(); setTimeout(()=>{ const app=[...document.querySelectorAll('.start-app')].find(a=>/Lov phishingu/i.test(a.textContent)); if(app) app.classList.add('done'); },10) };
    const _renderPrivacy=window.renderPrivacy; window.renderPrivacy=function(){ if(typeof shuffle!=='function'){window.shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}} if(Array.isArray(window.P_SETTINGS)) window.P_SETTINGS=shuffle(window.P_SETTINGS); _renderPrivacy&&_renderPrivacy(); };
    })();
  </script>

  <!-- QUIZ 1/2: S√≠to hesel (obal vlo≈æ p≈ôed </body>) -->
  <div id="quizOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="quizTitle">
    <div class="glass-card" id="quizCard">
      <h2 id="quizTitle" style="margin:0 0 10px">S√≠to hesel</h2>
      <div id="quizRoot"></div>
    </div>
  </div>

  <style>
  /* Classifier chips UI */
  .classif-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:12px;align-items:start;max-height:360px;overflow:auto;padding:6px}
  .classif-chip{
    display:flex;flex-direction:column;gap:6px;padding:10px;border-radius:12px;
    border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);
    cursor:pointer;user-select:none;min-height:72px;align-items:flex-start;
    transition:all 0.2s ease;
  }
  .classif-chip:hover{background:rgba(255,255,255,.08);transform:translateY(-1px)}
  .classif-chip.selected{background:linear-gradient(135deg, rgba(43,196,208,.15), rgba(43,196,208,.06));border-color:#2bc4d0;box-shadow:0 0 0 1px #2bc4d0}
  .classif-chip .title{font-weight:700;margin-bottom:2px;font-size:14px;line-height:1.2}
  .classif-chip .snippet{font-size:13px;opacity:.85;line-height:1.2;max-height:38px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
  .classif-chip .meta{font-size:12px;color:rgba(255,255,255,.6);margin-top:auto;font-weight:500}
  .classif-root{display:grid;gap:12px}
  .classif-instr{font-size:15px;line-height:1.3}
  .classif-controls{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px}
  .classif-progress{flex:1;height:8px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden;margin-left:12px}
  .classif-progress i{display:block;height:100%;width:0;transition:width .25s ease;background:#2bc4d0}
  .classif-feedback{min-height:20px;font-size:14px;margin-top:8px}
  .small-btn{all:unset;cursor:pointer;padding:10px 14px;border-radius:8px;background:rgba(255,255,255,.08);font-weight:800}
  .small-btn.primary{background:linear-gradient(135deg,#2bc4d0,#1e90ff);color:#003e44}
  .small-btn.warn{background:rgba(255,255,255,.06);color:#fff}
  @media (max-width:640px){ 
    .classif-grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;max-height:300px} 
    .classif-chip{min-height:80px;padding:8px}
    .classif-chip .title{font-size:13px}
    .classif-chip .snippet{font-size:12px;max-height:32px}
  }
  @media (max-width:420px){ 
    .classif-grid{grid-template-columns:1fr;gap:6px;max-height:280px} 
    .classif-chip{min-height:60px}
  }
  </style>

  <script>
  const PW_ITEMS=[
   {id:'i1',txt:'Dlouh√© alespo≈à 15 znak≈Ø',cat:'strong'},
   {id:'i2',txt:'Kombinace mal√Ωch i VELK√ùCH p√≠smen, ƒç√≠sel a symbol≈Ø',cat:'strong'},
   {id:'i3',txt:'T≈ôi n√°hodn√° slova (nap≈ô. k≈Ø≈à‚Äìjablko‚Äìmƒõs√≠c)',cat:'strong'},
   {id:'i4',txt:'Tƒõ≈æk√© uhodnout',cat:'strong'},
   {id:'i5',txt:'12345',cat:'weak'},
   {id:'i6',txt:'Slovo ‚Äûheslo"',cat:'weak'},
   {id:'i7',txt:'Obl√≠ben√° barva / zv√≠≈ôe',cat:'weak'},
   {id:'i8',txt:'Osobn√≠ informace (jm√©no, datum narozen√≠)',cat:'weak'}
  ];

  /* ===== Generic chip classifier (no drag&drop) ===== */
  function renderChipClassifier({rootId, items, pickPredicate, instrOptions, title, successCb, failCb, minPct=80}) {
    const root = document.getElementById(rootId);
    if(!root) return;
    
    // shuffle copy so order differs each run
    const list = items.slice();
    for(let i=list.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [list[i],list[j]]=[list[j],list[i]]; }

    const pickSelect = Math.random() < 0.5; // true -> "Oznaƒç ty, kter√© X" where X = predicate true
    const instr = (instrOptions && instrOptions.length) ? instrOptions[ pickSelect ? 0 : 1 ] : 
                  (pickSelect ? 'Oznaƒç polo≈æky, kter√© pat≈ô√≠ do c√≠le.' : 'Oznaƒç polo≈æky, kter√© NEpat≈ô√≠ do c√≠le.');

    // render
    root.innerHTML = `
      <div class="classif-root">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong style="font-size:16px">${title||''}</strong>
            <div class="classif-instr" id="${rootId}_instr">${instr}</div>
          </div>
          <div style="min-width:240px;display:flex;align-items:center;gap:8px">
            <button class="small-btn warn" id="${rootId}_reset">reset</button>
            <button class="small-btn primary" id="${rootId}_submit">Odevzdat</button>
          </div>
        </div>

        <div class="classif-grid" id="${rootId}_grid" aria-live="polite"></div>
        <div style="display:flex;align-items:center">
          <div id="${rootId}_status" class="classif-feedback"></div>
          <div class="classif-progress" aria-hidden="true"><i id="${rootId}_bar"></i></div>
        </div>
      </div>
    `;

    const grid = document.getElementById(`${rootId}_grid`);
    const bar  = document.getElementById(`${rootId}_bar`);
    const status = document.getElementById(`${rootId}_status`);

    // build chips
    list.forEach(it=>{
      // label text: try several fields
      const label = it.sub || it.name || it.txt || it.from || ('item-'+it.id);
      const snippet = it.body ? (it.body.replace(/\s+/g,' ').slice(0,120) + (it.body.length > 120 ? '...' : '')) : 
                      it.desc ? (it.desc.replace(/\s+/g,' ').slice(0,120) + (it.desc.length > 120 ? '...' : '')) : '';
      const meta = it.from ? it.from : (it.type ? it.type.toUpperCase() : '');
      const fullContent = it.body || it.desc || '';
      
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'classif-chip';
      chip.dataset.id = it.id;
      chip.title = fullContent ? fullContent.replace(/"/g, '&quot;') : label;
      
      let chipContent = `<div class="title">${label}</div>`;
      if(snippet) chipContent += `<div class="snippet">${snippet}</div>`;
      if(meta) chipContent += `<div class="meta">${meta}</div>`;
      
      chip.innerHTML = chipContent;
      chip.onclick = () => {
        chip.classList.toggle('selected');
        updateProgress();
      };
      chip.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); chip.click(); } });
      grid.appendChild(chip);
    });

    function updateProgress(){
      // spoƒç√≠tat pouze spr√°vn√° oznaƒçen√≠ (true positives)
      const targets = list.filter(it => pickPredicate(it)).map(i=>i.id);
      const picked = Array.from(grid.querySelectorAll('.classif-chip.selected')).map(n=>n.dataset.id);
      const truePos = picked.filter(id => targets.includes(id)).length;
      const targetCount = targets.length;
      const pct = targetCount ? Math.round((truePos/targetCount)*100) : 0;
      bar.style.width = Math.min(100, pct)+'%';
      status.textContent = `Spr√°vn√©: ${truePos}/${targetCount} (${pct}%)`;
    }
    updateProgress();

    // reset
    document.getElementById(`${rootId}_reset`).onclick = ()=> {
      grid.querySelectorAll('.classif-chip.selected').forEach(c=>c.classList.remove('selected'));
      status.textContent = 'resetov√°no';
      bar.style.width = '0%';
      setTimeout(()=> updateProgress(), 80);
    };

    // submit logic
    document.getElementById(`${rootId}_submit`).onclick = ()=> {
      const targets = list.filter(it => pickPredicate(it)).map(i=>i.id);
      const picked = Array.from(grid.querySelectorAll('.classif-chip.selected')).map(n=>n.dataset.id);
      const truePos = picked.filter(id => targets.includes(id)).length;
      const falsePos = picked.length - truePos;
      const falseNeg = targets.length - truePos;
      const pct = targets.length ? Math.round((truePos/targets.length)*100) : 0;
      
      // Check if instruction was inverted (pickSelect false means "mark opposite")
      const actualTruePos = pickSelect ? truePos : (list.length - picked.length - (targets.length - truePos));
      const actualFalsePos = pickSelect ? falsePos : picked.filter(id => !targets.includes(id)).length;
      const actualFalseNeg = pickSelect ? falseNeg : targets.filter(id => picked.includes(id)).length;
      
      if(pct >= minPct && (minPct < 100 || falsePos === 0)){
        status.innerHTML = `<span style="color:#7eff9c">Skvƒõl√©! ${pct}% ‚Äî ${truePos}/${targets.length} spr√°vnƒõ.</span>`;
        if(typeof successCb === 'function') successCb({pct,correct:truePos,total:targets.length});
      } else {
        let errorMsg = `Chyby: `;
        if(falsePos > 0) errorMsg += `+${falsePos} ≈°patnƒõ oznaƒçeno, `;
        if(falseNeg > 0) errorMsg += `-${falseNeg} vynech√°no, `;
        errorMsg += `(${pct}%). Zkus to znovu.`;
        status.innerHTML = `<span style="color:#ffb3b3">${errorMsg}</span>`;
        if(typeof failCb === 'function') failCb({pct,correct:truePos,total:targets.length,falsePos,falseNeg});
      }
    };
  }

  /* ===== Use for S√≠to hesel (optional variant) =====
     - treat PW_ITEMS, with pickPredicate: item.cat==='strong'
  */
  function openQuiz(){
    document.getElementById('quizOverlay').classList.remove('hidden');
    document.body.classList.add('modal-open');
    renderChipClassifier({
      rootId:'quizRoot',
      items: PW_ITEMS,
      pickPredicate: (i) => i.cat === 'strong',
      instrOptions: ['Oznaƒç tvrzen√≠, kter√° by mohla sedƒõt na SILN√â heslo.','Oznaƒç tvrzen√≠, kter√° by mohla sedƒõt na SLAB√â heslo.'],
      title: 'S√≠to hesel',
      minPct: 80,
      allowFalsePositives: true,
      successCb: ({pct})=>{
        grantEV && grantEV();
        setTimeout(()=>{ closeQuiz(); notifyNext(); },900);
      },
      failCb: ({pct})=>{
        setTimeout(()=>{ openQuiz(); },900);
      }
    });
  }
  
  function closeQuiz(){
    document.getElementById('quizOverlay').classList.add('hidden');
    document.body.classList.remove('modal-open');
  }

  /* pomocn√© ‚Äì m≈Ø≈æe≈° napojit na vlastn√≠ HUD / panel uƒçitele */
  // grantSeal je nyn√≠ definov√°na glob√°lnƒõ v IIFE



  function openNextTask(){
    // sem napoj pokraƒçov√°n√≠ (nap≈ô. otev≈ôi Wi-Fi √∫kol)
    // p≈ô√≠klad:
    if(typeof openWifiTask==='function'){ openWifiTask(); return; }
    // fallback ‚Äì jen informaƒçn√≠ modal, pokud dal≈°√≠ √∫kol je≈°tƒõ nen√≠
    if(typeof openSys==='function'){
      openSys('Pokraƒçuj','<p>Dal≈°√≠ √∫kol je p≈ôipraven v nab√≠dce Start.</p>');
    }
  }

  /* voliteln√©: extern√≠ API pro p≈ôid√°n√≠ nov√Ωch sad kartiƒçek */
  function setQuizItems(items){
    if(!Array.isArray(items)||!items.length) return;
    // oƒçek√°v√° [{id,txt,cat:'strong'|'weak'}, ...]
    items.forEach((it,idx)=>{ if(!it.id) it.id='ext'+idx; });
    window.PW_ITEMS=items;
    if(document.getElementById('quizOverlay') && !document.getElementById('quizOverlay').classList.contains('hidden')){
      renderQuiz();
    }
  }
  </script>

  <script>
  /* HOOK: zavolej po √∫spƒõchu √∫kolu ‚ÄûS√≠la hesel" */
  function grantEV(){
    setPart('ev','EV');
    try{ grantSeal && grantSeal('Lovec siln√Ωch hesel', 'EV'); }catch(e){}
    if(typeof showToast==='function') showToast('üî° Z√≠sk√°no: EV');
    if(typeof unlock==='function') unlock('EV');
  }
  </script>

  <!-- WIFI TASK -->
  <div id="wifiOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="wifiTitle">
    <div class="glass-card" id="wifiCard">
      <h2 id="wifiTitle" style="margin:0 0 10px">Wi-Fi p≈ô√≠zraky</h2>
      <div id="wifiRoot"></div>
    </div>
  </div>

  <style>
  .wifi-wrap{display:grid;gap:10px}
  .wifi-list{display:grid;gap:8px}
  .wifi-row{
    display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;
    background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.15);
    cursor:pointer;transition:all 0.2s ease;position:relative;
  }
  .wifi-row:hover{
    background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.25);
    transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.2);
  }
  .wifi-row:focus-within{
    outline:2px solid #2bc4d0;outline-offset:2px;
  }
  .wifi-row[aria-checked="true"]{
    background:rgba(43,196,208,.15);border-color:#2bc4d0;
    box-shadow:0 0 0 1px #2bc4d0, 0 4px 12px rgba(43,196,208,.3);
    transform:scale(1.02);
  }
  .wifi-row input[type="radio"]{
    position:absolute;opacity:0;width:100%;height:100%;margin:0;cursor:pointer;
  }
  .wifi-signal{
    display:flex;gap:1px;align-items:end;width:20px;height:16px;
  }
  .wifi-signal span{
    background:rgba(255,255,255,.6);border-radius:1px;
  }
  .wifi-signal .bar1{width:2px;height:4px}
  .wifi-signal .bar2{width:2px;height:8px}
  .wifi-signal .bar3{width:2px;height:12px}
  .wifi-signal .bar4{width:2px;height:16px}
  .wifi-row[aria-checked="true"] .wifi-signal span{background:#2bc4d0}
  .wifi-info{display:flex;flex-direction:column;gap:2px;flex:1;min-width:0}
  .wifi-name{font-weight:600;font-size:15px}
  .wifi-badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
  .wifi-badge{
    font-size:11px;padding:3px 8px;border-radius:12px;font-weight:600;
    background:rgba(0,0,0,.4);color:#fff;border:1px solid rgba(255,255,255,.2);
  }
  .wifi-badge.security{background:rgba(46,204,113,.2);color:#2ecc71;border-color:#2ecc71}
  .wifi-badge.open{background:rgba(231,76,60,.2);color:#e74c3c;border-color:#e74c3c}
  .wifi-badge.warning{background:rgba(230,126,34,.2);color:#e67e22;border-color:#e67e22}
  .wifi-controls{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .wifi-portal{display:grid;gap:10px}
  .wifi-check{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,.06)}
  .wifi-msg{margin-top:8px;font-size:14px;display:flex;align-items:center;gap:6px}
  
  @media (max-width: 360px) {
    .wifi-row{padding:16px 12px}
    .wifi-badges{margin-top:6px}
    .wifi-badge{padding:4px 10px;font-size:12px}
  }
  </style>

  <script>
  function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }
  
  let WIFI_NETWORKS=[
    {id:'n1', ssid:'PEKLO-NET', sec:'WPA3', hint:'≈†koln√≠ s√≠≈•', trust:'good', signal:4},
    {id:'n2', ssid:'PEKLO-free', sec:'OPEN', hint:'Bez hesla (NEBEZPEƒåN√â)', trust:'bad', signal:3},
    {id:'n3', ssid:'Shadow666', sec:'WPA2', hint:'Podez≈ôel√© klonov√°n√≠ (vyhnout se)', trust:'bad', signal:2},
    {id:'n4', ssid:'Hotspot_Martin', sec:'WPA2', hint:'Soukrom√Ω hotspot', trust:'bad', signal:3}
  ];
  WIFI_NETWORKS = shuffle(WIFI_NETWORKS);

  let _wifiSelected=null;

  function openWifiTask(){
    renderWifiSelect();
    document.getElementById('wifiOverlay').classList.remove('hidden');
    document.body.classList.add('modal-open');
  }
  function closeWifiTask(){
    document.getElementById('wifiOverlay').classList.add('hidden');
    document.body.classList.remove('modal-open');
  }

  function renderWifiSelect(){
    const root=document.getElementById('wifiRoot');
    const rows=WIFI_NETWORKS.map(n=>{
      const signalBars = Array.from({length:4}, (_, i) => 
        `<span class="bar${i+1}" style="opacity:${i < n.signal ? 1 : 0.3}"></span>`
      ).join('');
      
      const secBadgeClass = n.sec === 'OPEN' ? 'open' : 
                           n.trust === 'bad' ? 'warning' : 'security';
      
      return `
        <label class="wifi-row" aria-label="S√≠≈• ${n.ssid}">
          <input type="radio" name="wifiPick" value="${n.id}" aria-label="${n.ssid} - ${n.hint}">
          <div class="wifi-signal">${signalBars}</div>
          <div class="wifi-info">
            <div class="wifi-name">${n.ssid}</div>
            <div class="wifi-badges">
              <span class="wifi-badge ${secBadgeClass}">${n.sec}</span>
              <span class="wifi-badge">${n.hint}</span>
            </div>
          </div>
        </label>`;
    }).join('');
    
    root.innerHTML=`
      <div class="wifi-wrap">
        <p>Vyber s√≠≈•, ke kter√© se bezpeƒçnƒõ p≈ôipoj√≠≈°. Pak pokraƒçuj na port√°l a ovƒõ≈ô, ≈æe je to opravdu ≈°koln√≠ str√°nka.</p>
        <div class="wifi-list">${rows}</div>
        <div class="wifi-controls">
          <button class="btn-secondary" onclick="closeWifiTask()">Zav≈ô√≠t</button>
          <button class="btn-primary" id="wifiConnectBtn" onclick="wifiConnect()">P≈ôipojit</button>
        </div>
        <div class="wifi-msg" id="wifiMsg"></div>
      </div>`;
    _wifiSelected=null;
    setWifiMsg('');
    
    // P≈ôid√°n√≠ event listener≈Ø pro aria-checked
    document.querySelectorAll('input[name="wifiPick"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.querySelectorAll('.wifi-row').forEach(row => row.removeAttribute('aria-checked'));
        if(this.checked) {
          this.closest('.wifi-row').setAttribute('aria-checked', 'true');
        }
      });
    });
  }

  function setWifiMsg(t,ok){
    const el=document.getElementById('wifiMsg'); if(!el) return;
    const icon = ok ? '‚úÖ' : '‚ö†Ô∏è';
    el.innerHTML = `${icon} ${t}`;
    el.style.color=ok?'#7eff9c':'#ffcccc';
  }

  function wifiConnect(){
    const checked=document.querySelector('input[name="wifiPick"]:checked');
    const btn = document.getElementById('wifiConnectBtn');
    
    if(!checked){ 
      setWifiMsg('Vyber s√≠≈•.',false); 
      return; 
    }
    
    _wifiSelected=WIFI_NETWORKS.find(n=>n.id===checked.value);
    
    if(_wifiSelected.trust==='bad'){
      setWifiMsg(`S√≠≈• "${_wifiSelected.ssid}" je nebezpeƒçn√°! Zkus jinou.`,false);
      return;
    }
    
    // Zobrazit loading stav
    btn.disabled = true;
    btn.textContent = 'P≈ôipojuji...';
    setWifiMsg('P≈ôipojuji k bezpeƒçn√© s√≠ti...',true);
    
    setTimeout(() => {
      btn.disabled = false;
      btn.textContent = 'P≈ôipojit';
      renderPortalCheck();
    }, 1200);
  }

  function renderPortalCheck(){
    const root=document.getElementById('wifiRoot');
    const fakeHost = _wifiSelected?.ssid==='PEKLO-NET' ? 'portal.zs666.peklo-edu.cz' : 'peklo-login-security.net';
    const isHttps = _wifiSelected?.ssid==='PEKLO-NET';
    root.innerHTML=`
      <div class="wifi-portal">
        <p>Kontrola p≈ôihla≈°ovac√≠ str√°nky (captive portal):</p>
        <div class="wifi-check"><input id="chkHttps" type="checkbox"> <label for="chkHttps">Adresa zaƒç√≠n√° <code>https://</code> (secure)</label></div>
        <div class="wifi-check"><input id="chkDomain" type="checkbox"> <label for="chkDomain">Dom√©na odpov√≠d√° ≈°kole: <code>zs666.peklo-edu.cz</code></label></div>
        <div style="padding:10px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)">
          <div>Adresa str√°nky: <code>${isHttps?'https://':'http://'}${fakeHost}/login</code></div>
          <div>Certifik√°t: ${isHttps?'platn√Ω ‚úÖ':'neplatn√Ω/≈æ√°dn√Ω ‚ö†Ô∏è'}</div>
        </div>
        <div class="wifi-controls">
          <button class="btn-secondary" onclick="renderWifiSelect()">Zpƒõt</button>
          <button class="btn-primary" onclick="wifiScore()">Potvrdit</button>
        </div>
        <div class="wifi-msg" id="wifiMsg"></div>
      </div>`;
    setWifiMsg('Zatrhni spr√°vn√° tvrzen√≠ a potvrƒè.',true);
  }

  function wifiScore(){
    // spr√°vn√° s√≠≈• je PEKLO-NET (WPA3) + spr√°vnƒõ oznaƒçen√© https a dom√©na ≈°koly
    const netOk = _wifiSelected && _wifiSelected.ssid==='PEKLO-NET' && _wifiSelected.sec==='WPA3';
    const chkHttps = document.getElementById('chkHttps')?.checked;
    const chkDomain = document.getElementById('chkDomain')?.checked;
    const bothOk = netOk && chkHttps && chkDomain;

    if(bothOk){
      setWifiMsg('Spr√°vnƒõ! Bezpeƒçn√© p≈ôipojen√≠ ovƒõ≈ôeno. D√≠lek hesla: 777',true);
      storeKeyPart('school', '777');
      grantSeal && grantSeal('Str√°≈æce s√≠tƒõ', '777');
      if(typeof unlock==='function') unlock('777');
      setTimeout(()=>{ closeWifiTask(); notifyNext(); },900);
    }else{
      setWifiMsg('Pozor! Nƒõco nen√≠ v po≈ô√°dku. Vrac√≠me tƒõ na zaƒç√°tek cviƒçen√≠.',false);
      setTimeout(()=>{ renderWifiSelect(); },900);
    }
  }

  /* voliteln√° ve≈ôejn√° funkce pro spu≈°tƒõn√≠ z nab√≠dky Start / ikony */
  function openWifiFromDesktop(){ openWifiTask(); }
  </script>

  <!-- PHISHING 1/2 -->
  <div id="phishOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="phishTitle">
    <div class="glass-card" id="phishCard">
      <h2 id="phishTitle" style="margin:0 0 10px">Lov phishingu</h2>
      <div id="phishRoot"></div>
    </div>
  </div>



  <script>
  const MAIL_ITEMS=[
   {id:'m1',from:'noreply@bank.cz',sub:'Urgent: potvrƒè platbu',body:'Klikni a potvrƒè platbu do 24 hodin, jinak bude √∫ƒçet zablokov√°n. Urgentn√≠ akce vy≈æadov√°na!',phish:true},
   {id:'m2',from:'ucebnice@zs666.peklo-edu.cz',sub:'√ökol ke sta≈æen√≠',body:'Najde≈° zad√°n√≠ v p≈ô√≠loze. Odevzd√°n√≠ do p√°tku 18:00.',phish:false},
   {id:'m3',from:'support@goog1e.com',sub:'Zabezpeƒçte √∫ƒçet',body:'P≈ôihlaste se p≈ôes odkaz a ovƒõ≈ôte identitu. Podez≈ôel√° aktivita detekov√°na.',phish:true},
   {id:'m4',from:'kolega@zs666.peklo-edu.cz',sub:'Sd√≠len√≠ dokumentu',body:'Otev≈ôi dokument v Drive - spoleƒçn√Ω projekt na p≈ô√≠≈°t√≠ t√Ωden.',phish:false},
   {id:'m5',from:'promo@super-slevy.com',sub:'Vyhr√°l jsi telefon!',body:'Vypl≈à formul√°≈ô pro v√Ωhru iPhone 15 Pro! Pouze dnes, limitovan√° nab√≠dka!',phish:true},
   {id:'m6',from:'admin@zs666.peklo-edu.cz',sub:'Zmƒõna rozvrhu',body:'Nov√Ω rozvrh v pdf p≈ô√≠loze. Plat√≠ od pondƒõl√≠ 4.11.',phish:false}
  ];

  function openPhishingTask(){ renderPhishing(); document.getElementById('phishOverlay').classList.remove('hidden'); document.body.classList.add('modal-open'); }
  function closePhishingTask(){ document.getElementById('phishOverlay').classList.add('hidden'); document.body.classList.remove('modal-open'); }

  function renderPhishing(){
    renderChipClassifier({
      rootId: 'phishRoot',
      items: MAIL_ITEMS,
      pickPredicate: item => item.phish === true,
      instrOptions: [
        'Oznaƒç v≈°echny PHISHING e-maily (podvodn√©)',
        'Oznaƒç v≈°echny D≈ÆVƒöRYHODN√â e-maily'
      ],
      title: 'Lov phishingu',
      minPct: 100,
      allowFalsePositives: false,
      successCb: ({pct}) => {
        storeKeyPart('ro', 'RO');
        try{ grantSeal && grantSeal('Lovec phishingu', 'RO'); }catch(e){}
        if(typeof unlock==='function') unlock('RO');
        setTimeout(() => { closePhishingTask(); notifyNext(); }, 900);
      },
      failCb: ({pct}) => {
        setTimeout(() => { renderPhishing(); }, 900);
      }
    });
  }

  /* voliteln√©: doplnƒõn√≠ nov√© sady mail≈Ø z JSON */
  function setPhishItems(items){
    if(!Array.isArray(items) || !items.length) return;
    items.forEach((it,idx)=>{ if(!it.id) it.id='p'+idx; });
    window.MAIL_ITEMS = items;
    if(document.getElementById('phishOverlay') && !document.getElementById('phishOverlay').classList.contains('hidden')){
      renderPhishing();
    }
  }

  /* fallbacky (pokud v projektu nejsou) */
  // grantSeal je nyn√≠ definov√°na glob√°lnƒõ v IIFE
  if(typeof openNextTask !== 'function'){
    window.openNextTask = function(){ if(typeof openSys==='function') openSys('Info','Dal≈°√≠ √∫kol bude brzy dostupn√Ω.'); };
  }
  </script>

  <!-- 2FA TASK: Dvoufaktorov√° br√°na -->
  <div id="faOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="faTitle">
    <div class="glass-card" id="faCard">
      <h2 id="faTitle" style="margin:0 0 10px">Dvoufaktorov√° br√°na</h2>
      <div id="faRoot"></div>
    </div>
  </div>

  <style>
  .fa-wrap{display:grid;gap:10px}
  .fa-hints{display:grid;gap:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
  .fa-row{display:flex;gap:10px;align-items:center}
  .fa-row input[type=text]{flex:1;border:1px solid rgba(255,255,255,.35);background:rgba(3,3,3,.16);color:#fff;border-radius:8px;padding:10px 12px;font-size:16px;outline:none}
  .fa-controls{display:flex;gap:8px;justify-content:flex-end}
  .fa-msg{font-size:14px;margin-top:8px}
  .hint{font-size:14px;opacity:.9}
  .bad{color:#ffcccc}
  .good{color:#7eff9c}
  </style>

  <script>
  /* 2FA: postupn√© n√°povƒõdy */
  const FA_HINTS = [
    "1) Zjisti d√©lku slova EVROPA.",
    "2) Kolik samohl√°sek ve slovƒõ EVROPA?",
    "3) ƒå√≠slo ≈°koly (hledej v √∫kolech).",
    "4) Nakonec mƒõs√≠c (MM).",
  ];

  /* otev≈ôen√≠/zav≈ôen√≠ 2FA */
  function open2FATask(){
    render2FA();
    document.getElementById('faOverlay').classList.remove('hidden');
    document.body.classList.add('modal-open');
  }
  function close2FATask(){
    document.getElementById('faOverlay').classList.add('hidden');
    document.body.classList.remove('modal-open');
  }

  function render2FA(){
    const root=document.getElementById('faRoot');
    root.innerHTML=`<div class="fa-wrap"><p>Br√°na vy≈æaduje 6m√≠stn√Ω k√≥d. Klikni pro postupnou n√°povƒõdu.</p>
     <div id="faHints" style="cursor:pointer;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);min-height:60px"></div>
     <div class="fa-row"><input id="faCode" maxlength=6 placeholder="Zadej k√≥d"><button class="btn-primary" onclick="submit2FA()">Ovƒõ≈ôit</button></div>
     <div class="fa-controls"><button class="btn-secondary" onclick="close2FATask()">Zav≈ô√≠t</button></div><div id="faMsg" class="fa-msg"></div></div>`;
    let idx=0; const hintsEl=document.getElementById('faHints');
    function next(){ if(idx<FA_HINTS.length){ const p=document.createElement('div'); p.className='hint'; p.textContent=FA_HINTS[idx++]; hintsEl.appendChild(p); } }
    // klikni kamkoliv do hint boxu pro dal≈°√≠
    hintsEl.addEventListener('click', next);
    // prvn√≠ hint
    next();
  }

  /* submit2FA: p≈ôesmƒõrov√°n√≠ na fin√°ln√≠ z√°mek */
  function submit2FA(){
    const v=(document.getElementById('faCode').value||'').replace(/\D/g,'');
    if(v.length!==6){ setFAMsg('K√≥d mus√≠ m√≠t 6 ƒç√≠slic.', false); return; }
    // Sestav√≠me oƒçek√°van√Ω k√≥d z buildFinalPassword a pak z nƒõj vyt√°hneme posledn√≠ch 6 ƒç√≠slic
    const target = buildFinalPassword().replace(/\s+/g,'').toUpperCase();
    const digits = target.replace(/\D/g,''); // odstran√≠me p√≠smena => nech√°me jen ƒç√≠sla
    const expect = digits.slice(-6);
    if(v === expect){
      setFAMsg('Ovƒõ≈ôeno. P≈ôesmƒõrov√°n√≠ na fin√°ln√≠ z√°mek‚Ä¶', true);
      try{ grantSeal && grantSeal('Str√°≈æce identity', '2FA'); }catch(e){}
      if(typeof unlock==='function') unlock('2FA');
      setTimeout(()=>{ close2FATask(); openFinalLock(); },700);
    } else {
      setFAMsg('Nespr√°vn√Ω k√≥d. Zkontroluj √∫koly a n√°povƒõdy.', false);
    }
  }
  function setFAMsg(t,ok){ const el=document.getElementById('faMsg'); if(!el) return; el.textContent=t; el.style.color= ok? '#7eff9c':'#ffcccc'; }

  /* voliteln√Ω launcher z dal≈°√≠ho √∫kolu */
  if(typeof openNextTask==='function'){ /* m≈Ø≈æe≈° sem napojit ≈ôetƒõzen√≠ */ }
  </script>

  <!-- FILE TASK: Souborov√° past -->
  <div id="fileOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="fileTitle">
    <div class="glass-card" id="fileCard">
      <h2 id="fileTitle" style="margin:0 0 10px">Souborov√° past</h2>
      <div id="fileRoot"></div>
    </div>
  </div>



  <script>
  const FILE_ITEMS=[
   {id:'f1',name:'zadani.pdf',type:'PDF',desc:'√ökol pro matematiku - bezpeƒçn√Ω dokument',danger:false},
   {id:'f2',name:'stahuj.exe',type:'EXE',desc:'Spustiteln√Ω soubor z nezn√°m√©ho zdroje - m≈Ø≈æe obsahovat malware',danger:true},
   {id:'f3',name:'foto.jpg',type:'JPG',desc:'Obr√°zek z akce ≈°koly - ovƒõ≈ôen√Ω zdroj',danger:false},
   {id:'f4',name:'rozvrh.xlsm',type:'XLSM',desc:'Excel s makry - m≈Ø≈æe spou≈°tƒõt ≈°kodliv√Ω k√≥d',danger:true},
   {id:'f5',name:'update.zip',type:'ZIP',desc:'Archiv obsahuje .exe soubory - podez≈ôel√Ω',danger:true},
   {id:'f6',name:'plan.pdf',type:'PDF',desc:'Aktualizovan√Ω pl√°n od uƒçitele - d≈Øvƒõryhodn√Ω',danger:false}
  ];

  /* ===== Use for File Task (replaces DnD) ===== */
  function openFileTask(){
    document.getElementById('fileOverlay').classList.remove('hidden');
    document.body.classList.add('modal-open');
    renderChipClassifier({
      rootId:'fileRoot',
      items: FILE_ITEMS,
      pickPredicate: (f) => !!f.danger,
      instrOptions: ['Oznaƒç v≈°echny NEBEZPEƒåN√â soubory (neotv√≠rat)', 'Oznaƒç v≈°echny BEZPEƒåN√â soubory'],
      title: 'Souborov√° past',
      minPct: 100,
      allowFalsePositives: false,
      successCb: ({pct})=>{
        storeKeyPart && storeKeyPart('plus','+');
        try{ grantSeal && grantSeal('Str√°≈æce soubor≈Ø','+'); }catch(e){}
        if(typeof unlock==='function') unlock('+');
        setTimeout(()=>{ closeFileTask(); notifyNext(); },900);
      },
      failCb: ({pct})=>{
        setTimeout(()=>{ openFileTask(); },900);
      }
    });
  }
  function closeFileTask(){ document.getElementById('fileOverlay').classList.add('hidden'); document.body.classList.remove('modal-open'); }

  /* voliteln√© API: nahr√°n√≠ jin√© sady soubor≈Ø (nap≈ô. z JSON) */
  function setFileItems(items){
    if(!Array.isArray(items)||!items.length) return;
    items.forEach((it,idx)=>{ if(!it.id) it.id='f'+idx; if(typeof it.danger!=='boolean') it.danger=false; });
    window.FILE_ITEMS=items;
    if(document.getElementById('fileOverlay') && !document.getElementById('fileOverlay').classList.contains('hidden')){
      renderFileTask();
    }
  }

  /* fallbacky pro peƒçe≈•/≈ôetƒõzen√≠ (pokud v projektu nejsou) */
  // grantSeal je nyn√≠ definov√°na glob√°lnƒõ v IIFE
  if(typeof openPrivacyTask!=='function'){ window.openPrivacyTask=function(){ if(typeof openSys==='function') openSys('Dal≈°√≠','√ökol soukrom√≠ je p≈ôipraven.'); }; }
  </script>

  <!-- PRIVACY SHIELD -->
  <div id="privacyOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="pTitle">
    <div class="glass-card" style="max-width:520px">
      <h2 id="pTitle" style="margin:0 0 10px">üõ°Ô∏è ≈†t√≠t soukrom√≠</h2>
      <div id="pRoot"></div>
    </div>
  </div>

  <!-- FINAL LOCK -->
  <div id="finalLockOverlay" class="final-lock-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="finalLockTitle">
    <div class="final-lock-card">
      <h1 id="finalLockTitle" class="final-lock-title">üîê FIN√ÅLN√ç Z√ÅMEK</h1>
      <div class="lock-hints">
        <h4>Zadej z√≠skan√© d√≠lky hesla:</h4>
        <div>Kontinent ‚Ä¢ matematick√© znam√©nko ‚Ä¢ ƒç√≠slo ≈°koly+111 ‚Ä¢ MM - aktu√°ln√≠ mƒõs√≠c</div>
      </div>
      <div class="lock-segments">
        <div class="lock-segment">
          <div class="lock-segment-label">D√≠lek 1</div>
          <input id="seg1" maxlength="2" placeholder="‚Ä¢‚Ä¢" autocomplete="off">
        </div>
        <div class="lock-segment">
          <div class="lock-segment-label">D√≠lek 2</div>
          <input id="seg2" maxlength="2" placeholder="‚Ä¢‚Ä¢" autocomplete="off">
        </div>
        <div class="lock-segment">
          <div class="lock-segment-label">D√≠lek 3</div>
          <input id="seg3" maxlength="2" placeholder="‚Ä¢‚Ä¢" autocomplete="off">
        </div>
        <div class="lock-segment">
          <div class="lock-segment-label">D√≠lek 4</div>
          <input id="seg4" maxlength="1" placeholder="‚Ä¢" autocomplete="off">
        </div>
        <div class="lock-segment">
          <div class="lock-segment-label">D√≠lek 5</div>
          <input id="seg5" maxlength="3" placeholder="‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
        </div>
        <div class="lock-segment">
          <div class="lock-segment-label">D√≠lek 6</div>
          <input id="seg6" maxlength="2" placeholder="‚Ä¢‚Ä¢" autocomplete="off">
        </div>
      </div>
      <div class="lock-controls">
        <button class="lock-btn secondary" onclick="closeFinalLock()">Zav≈ô√≠t</button>
        <button class="lock-btn primary" onclick="validateFinalLock()">Odemknout</button>
      </div>
      <div id="lockMessage" class="lock-message"></div>
    </div>
  </div>

  <!-- FINAL LOCK (old version kept for compatibility) -->
  <div id="finalOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="finalTitle">
    <div class="glass-card" style="max-width:520px">
      <h2 id="finalTitle" style="margin:0 0 10px">üîê Velk√Ω z√°mek</h2>
      <div id="finalRoot"></div>
    </div>
  </div>

  <style>
  .final-wrap{display:grid;gap:10px}
  .final-hints{display:grid;gap:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px}
  .final-row{display:grid;gap:8px}
  .final-row input{border:1px solid rgba(255,255,255,.35);background:rgba(3,3,3,.16);color:#fff;border-radius:8px;padding:10px 12px;font-size:16px;outline:none}
  .final-ctrl{display:flex;gap:8px;justify-content:flex-end}
  .final-msg{font-size:14px;margin-top:6px}
  .hint{font-size:14px;opacity:.9}

  .p-wrap{display:grid;gap:10px}
  .p-row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:12px;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,.03);margin-bottom:8px}
  .p-row span{font-size:14px;line-height:1.3}
  .p-ctrl{display:flex;gap:8px;justify-content:flex-end}
  .p-msg{font-size:14px;margin-top:6px}
  .p-ok{outline:2px solid #7eff9c}
  .p-bad{outline:2px solid #ff9b9b}
  .toggle{position:relative;width:42px;height:22px;background:#444;border-radius:22px;cursor:pointer;transition:background .3s;appearance:none;border:none;outline:none}
  .toggle::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:.3s}
  .toggle:checked{background:#2bc4d0}
  .toggle:checked::after{left:23px}
  </style>

  <script>
  function openFinalTask(){ 
    renderFinal(); 
    document.getElementById('finalOverlay').classList.remove('hidden'); 
    document.body.classList.add('modal-open'); 
  }
  function closeFinalTask(){ 
    document.getElementById('finalOverlay').classList.add('hidden'); 
    document.body.classList.remove('modal-open'); 
  }

  function renderFinal(){
    const r=document.getElementById('finalRoot');
    const collectedParts = Object.entries(window.finalKeyParts)
      .filter(([key, value]) => value !== null)
      .map(([key, value]) => `<span style="color:#7eff9c">${value}</span>`)
      .join(' ');
    
    const expectedPassword = buildFinalPassword();
    
    r.innerHTML=`
      <div class="final-wrap">
        <p>Poskl√°dej <strong>tajnou fr√°zi</strong> z d√≠lk≈Ø, kter√© jsi z√≠skal bƒõhem √∫kol≈Ø:</p>
        <div class="final-hints">
          <div class="hint">Z√≠skan√© d√≠lky: ${collectedParts || '<em>≈æ√°dn√© zat√≠m</em>'}</div>
          <div class="hint">1) <strong>EV</strong> - ze "S√≠to hesel" (spr√°vn√© hodnocen√≠ hesel)</div>
          <div class="hint">2) <strong>RO</strong> - z "Lov phishingu" (rozpozn√°n√≠ podvodn√Ωch mail≈Ø)</div>
          <div class="hint">3) <strong>PA</strong> - ze "≈†t√≠t soukrom√≠" (spr√°vn√© nastaven√≠)</div>
          <div class="hint">4) <strong>+</strong> - ze "Souborov√° past" (matematick√© znam√©nko)</div>
          <div class="hint">5) <strong>777</strong> - z "Wi-Fi p≈ô√≠zraky" (ƒç√≠slo ≈°koly)</div>
          <div class="hint">6) <strong>111</strong> - pevn√° ƒç√°st</div>
          <div class="hint">7) <strong>${monthMM()}</strong> - aktu√°ln√≠ mƒõs√≠c</div>
          <div class="hint">Spojeno: <code>${expectedPassword}</code></div>
        </div>
        <div class="final-row">
          <input id="finalInput" type="text" placeholder="Nap≈ô. EVROPA+777111MM" autocomplete="off">
          <div class="final-ctrl">
            <button class="btn-secondary" onclick="closeFinalTask()">Zav≈ô√≠t</button>
            <button class="btn-primary" onclick="checkFinal()">Odemknout</button>
          </div>
          <div id="finalMsg" class="final-msg"></div>
        </div>
      </div>`;
    setFinalMsg(hasAllKeyParts() ? 'V≈°echny d√≠lky z√≠sk√°ny! Zkontroluj a odemkni.' : 'Nƒõkter√© d√≠lky je≈°tƒõ chyb√≠. Dokonƒç v≈°echny √∫koly.');
    setTimeout(()=>document.getElementById('finalInput').focus(),100);
  }

  function norm(s){ return (s||'').trim().replace(/\s+/g,''); }
  function setFinalMsg(t,ok){ 
    const m=document.getElementById('finalMsg'); 
    if(!m) return; 
    m.textContent=t; 
    m.style.color=ok?'#7eff9c':'#ffcccc'; 
  }

  function checkFinal(){
    const userInput = norm(document.getElementById('finalInput').value);
    const expectedPassword = buildFinalPassword();
    
    if(!hasAllKeyParts()){
      setFinalMsg('‚ùå Nejprve dokonƒçi v≈°echny √∫koly a z√≠skej v≈°echny d√≠lky hesla!',false);
      return;
    }
    
    if(userInput === expectedPassword){
      setFinalMsg('‚úÖ Odemƒçeno! Port√°l se otev√≠r√°‚Ä¶',true);
      try{ grantSeal && grantSeal('Mistr br√°ny'); }catch(e){}
      setTimeout(()=>{ 
        closeFinalTask(); 
        if(typeof openSys==='function'){ 
          openSys('üéâ Gratulace','Splnil(a) jsi v≈°echny zkou≈°ky! Jsi nyn√≠ certifikovan√Ω str√°≈æce digit√°ln√≠ bezpeƒçnosti.'); 
        } 
      },900);
    }else{
      const missing = Object.entries(finalKeyParts)
        .filter(([key, value]) => value === null)
        .map(([key]) => key);
      
      if(missing.length > 0){
        setFinalMsg(`‚ùå Chyb√≠ d√≠lky: ${missing.join(', ')}. Dokonƒçi p≈ô√≠slu≈°n√© √∫koly.`,false);
      }else{
        setFinalMsg(`‚ùå Nespr√°vnƒõ zad√°no. Oƒçek√°v√°no: ${expectedPassword}`,false);
      }
    }
  }

  // Enter key support
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !document.getElementById('finalOverlay').classList.contains('hidden')) {
      const input = document.getElementById('finalInput');
      if (input && document.activeElement === input) {
        checkFinal();
      }
    }
  });

  // Privacy Shield Task
  const P_SETTINGS=[
    {id:'prv',label:'Profil viditeln√Ω jen pro p≈ô√°tele',should:true},
    {id:'tag',label:'Schvalovat oznaƒçen√≠ na fotk√°ch',should:true},
    {id:'loc',label:'Sd√≠len√≠ polohy u p≈ô√≠spƒõvk≈Ø',should:false},
    {id:'dm', label:'P≈ôij√≠mat zpr√°vy od v≈°ech',should:false},
    {id:'ad', label:'Personalizovan√© reklamy (sledov√°n√≠)',should:false},
    {id:'two',label:'Upozornƒõn√≠ p≈ôi p≈ôihl√°≈°en√≠ z nov√©ho za≈ô√≠zen√≠',should:true},
  ];

  function openPrivacyTask(){ renderPrivacy(); document.getElementById('privacyOverlay').classList.remove('hidden'); document.body.classList.add('modal-open'); }
  function closePrivacyTask(){ document.getElementById('privacyOverlay').classList.add('hidden'); document.body.classList.remove('modal-open'); }

  function renderPrivacy(){
    const r=document.getElementById('pRoot');

    // vytvo≈ô√≠me kopii P_SETTINGS (aby origin√°l s .should z≈Østal neporu≈°en)
    const settings = P_SETTINGS.map(s => ({...s}));

    // zam√≠ch√°me po≈ôad√≠, aby byl v≈ædy jin√Ω layout
    shuffle(settings);

    // p≈ôi≈ôad√≠me n√°hodn√© poƒç√°teƒçn√≠ hodnoty (true/false)
    // Tyto hodnoty jsou jen poƒç√°teƒçn√≠ stav checkbox≈Ø, neoƒçek√°v√° se, ≈æe budou
    // odpov√≠dat s.should ‚Äî hr√°ƒç mus√≠ upravit, aby sedƒõly.
    settings.forEach(s => {
      s.initial = Math.random() < 0.5; // ~50/50 true/false
    });

    // vytvo≈ô√≠ ≈ô√°dky podle zam√≠chan√©ho a n√°hodnƒõ nastaven√©ho po≈ôad√≠
    const rows = settings.map(s => `
      <div class="p-row" data-id="${s.id}">
        <span>${s.label}</span>
        <input class="toggle" type="checkbox" id="sw_${s.id}" ${s.initial ? 'checked' : ''}>
      </div>
    `).join('');

    r.innerHTML=`
      <div class="p-wrap">
        <p>Nastav profil tak, aby byl <b>bezpeƒçn√Ω</b>. Pak stiskni Ovƒõ≈ôit.</p>
        ${rows}
        <div class="p-ctrl">
          <button class="btn-secondary" onclick="closePrivacyTask()">Zav≈ô√≠t</button>
          <button class="btn-primary" onclick="scorePrivacy()">Ovƒõ≈ôit</button>
        </div>
        <div id="pMsg" class="p-msg"></div>
      </div>`;

    setPMsg('U t≈ô√≠ polo≈æek m√° b√Ωt vypnuto, u t≈ô√≠ zapnuto.');
  }

  function scorePrivacy(){
    let ok=0;
    P_SETTINGS.forEach(s=>{
      const row=document.querySelector(`.p-row[data-id="${s.id}"]`);
      const cur=document.getElementById(`sw_${s.id}`).checked;
      const good=cur===s.should; row.classList.toggle('p-ok',good); row.classList.toggle('p-bad',!good);
      if(good) ok++;
    });
    if(ok===P_SETTINGS.length){
      setPMsg('‚úÖ Spr√°vnƒõ! Tv√© soukrom√≠ je v bezpeƒç√≠. D√≠lek hesla: PA',true);
      storeKeyPart('pa', 'PA');
      try{ grantSeal && grantSeal('Str√°≈æce soukrom√≠', 'PA'); }catch(e){}
      if(typeof unlock==='function') unlock('PA');
      setTimeout(()=>{ closePrivacyTask(); notifyNext('Skvƒõl√©! Z√≠skal(a) jsi v≈°ech pƒõt peƒçet√≠. Jdi k fin√°ln√≠mu z√°mku!'); },900);
    }else{
      setPMsg(`Nƒõco nesed√≠ (${ok}/${P_SETTINGS.length}). Uprav p≈ôep√≠naƒçe.`,false);
    }
  }

  function setPMsg(t,good){const el=document.getElementById('pMsg'); if(!el) return; el.textContent=t; el.style.color=good?'#7eff9c':'#ffcccc';}
  </script>

  <script>
    // alias pro start menu ‚Üí p≈ôesmƒõruje na skuteƒçnou funkci
    window.openPhishTask = function(){ 
      if (typeof window.openPhishingTask === 'function') window.openPhishingTask();
    };

    // Final Lock Functions
    function openFinalLock(){
      document.getElementById('finalLockOverlay').classList.remove('hidden');
      document.body.classList.add('modal-open');
      
      // Clear all fields - no pre-filling
      document.getElementById('seg1').value = '';
      document.getElementById('seg2').value = '';
      document.getElementById('seg3').value = '';
      document.getElementById('seg4').value = '';
      document.getElementById('seg5').value = '';
      document.getElementById('seg6').value = '';
      
      // Focus first field
      setTimeout(() => document.getElementById('seg1').focus(), 100);
      
      setLockMessage('Zadej v≈°echny d√≠lky hesla pro odemknut√≠ fin√°ln√≠ br√°ny.');
    }

    function closeFinalLock(){
      document.getElementById('finalLockOverlay').classList.add('hidden');
      document.body.classList.remove('modal-open');
    }

    function validateFinalLock(){
      const segments = document.querySelectorAll('.lock-segment');
      const values = [
        document.getElementById('seg1').value.toUpperCase().trim(),
        document.getElementById('seg2').value.toUpperCase().trim(),
        document.getElementById('seg3').value.toUpperCase().trim(),
        document.getElementById('seg4').value.trim(),
        document.getElementById('seg5').value.trim(),
        document.getElementById('seg6').value.padStart(2, '0').trim()
      ];
      
      // Expected values: EV + RO + PA + + + 777 + 11 + MM
      const currentMonth = monthMM();
      const expectedValues = ['EV', 'RO', 'PA', '+', '777', currentMonth];
      
      let allCorrect = true;
      let errors = [];
      
      // Check each field individually
      values.forEach((value, index) => {
        const segment = segments[index];
        segment.classList.remove('error', 'success');
        
        if(!value) {
          segment.classList.add('error');
          allCorrect = false;
          errors.push(`Chyb√≠ d√≠lek ${index + 1}`);
        } else if(value !== expectedValues[index]) {
          segment.classList.add('error');
          allCorrect = false;
        } else {
          segment.classList.add('success');
        }
      });
      
      // If all correct, show success
      if(allCorrect && values.every((val, idx) => val === expectedValues[idx])) {
        setLockMessage('üéâ Z√ÅMEK ODEMƒåEN! Gratulace, pro≈°el jsi v≈°emi zkou≈°kami!', 'success');
        
        // Add final seal
        try {
          if(typeof grantSeal === 'function') {
            grantSeal('Mistr fin√°ln√≠ br√°ny', 'KOMPLETN√ç');
          }
        } catch(e) {}
        
        // Show victory message after delay
        setTimeout(() => {
          closeFinalLock();
          if(typeof openSys === 'function') {
            openSys('üèÜ V√çTƒöZSTV√ç', 
              '<div style="text-align:center;padding:20px;">' +
              '<h3 style="color:#2ecc71;margin:0 0 15px;">Gratulace!</h3>' +
              '<p>√öspƒõ≈°nƒõ jsi pro≈°el v≈°emi bezpeƒçnostn√≠mi zkou≈°kami a odemkl fin√°ln√≠ br√°nu.</p>' +
              '<p><strong>Jsi nyn√≠ certifikovan√Ω str√°≈æce digit√°ln√≠ bezpeƒçnosti!</strong></p>' +
              '<p style="margin-top:20px;font-size:14px;opacity:0.8;">Z√≠skan√© dovednosti: Rozpozn√°v√°n√≠ siln√Ωch hesel ‚Ä¢ Detekce phishingu ‚Ä¢ Bezpeƒçn√© Wi-Fi p≈ôipojen√≠ ‚Ä¢ Ochrana soubor≈Ø ‚Ä¢ Nastaven√≠ soukrom√≠</p>' +
              '</div>'
            );
          }
        }, 2000);
        
      } else {
        if(errors.length > 0) {
          setLockMessage(`‚ùå ${errors.join(', ')}.`, 'error');
        } else {
          setLockMessage('‚ùå Nespr√°vn√° kombinace. Zkontroluj z√≠skan√© d√≠lky v √∫kolech.', 'error');
        }
      }
      
      // Shake animation for errors
      if(!allCorrect) {
        setTimeout(() => {
          segments.forEach(seg => seg.classList.remove('error'));
        }, 500);
      }
    }

    function setLockMessage(text, type = '') {
      const messageEl = document.getElementById('lockMessage');
      if(!messageEl) return;
      
      messageEl.textContent = text;
      messageEl.className = 'lock-message' + (type ? ' ' + type : '');
    }

    // Auto-advance to next field on input
    document.addEventListener('DOMContentLoaded', () => {
      const segments = ['seg1', 'seg2', 'seg3', 'seg4', 'seg5', 'seg6'];
      
      segments.forEach((segId, index) => {
        const input = document.getElementById(segId);
        if(!input) return;
        
        input.addEventListener('input', (e) => {
          const value = e.target.value;
          const maxLength = parseInt(e.target.getAttribute('maxlength'));
          
          // Auto-advance to next field when max length reached
          if(value.length === maxLength && index < segments.length - 1) {
            const nextInput = document.getElementById(segments[index + 1]);
            if(nextInput) {
              setTimeout(() => nextInput.focus(), 50);
            }
          }
        });
        
        // Handle backspace to go to previous field
        input.addEventListener('keydown', (e) => {
          if(e.key === 'Backspace' && e.target.value === '' && index > 0) {
            const prevInput = document.getElementById(segments[index - 1]);
            if(prevInput) {
              setTimeout(() => prevInput.focus(), 50);
            }
          }
          
          // Handle Enter to validate
          if(e.key === 'Enter') {
            validateFinalLock();
          }
        });
      });
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'987a9a90436db374',t:'MTc1OTMwNzQ4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
